<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©é©¬å›­åŒº | ç»¼åˆäººåŠ›æ’ç­å†³ç­–æ¨¡å‹</title>
    <meta name="robots" content="noindex, nofollow">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        :root {
            --bg-color: #FDFCFB;
            --text-main: #2C3E50;
            --text-sub: #7F8C8D;
            --border-color: #E0E0E0;
            
            /* è«å…°è¿ªé…è‰² */
            --roche-blue: #77929F;
            --roche-sand: #D4C4B7;
            --device-green: #9CAF88;
            --medicine-purple: #95A5A6; 
        }

        body {
            font-family: "Microsoft YaHei", "Heiti SC", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            gap: 20px;
            height: 100vh;
            overflow: hidden;
            box-sizing: border-box;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 340px;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            height: 100%;
            overflow-y: auto;
            flex-shrink: 0;
            scrollbar-width: thin;
        }
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 3px; }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
            overflow-y: auto;
            padding-right: 5px;
        }

        h1 { font-size: 24px; color: #5C6E7D; margin: 0 0 5px 0; }
        h3 { font-size: 15px; margin: 15px 0 10px 0; color: var(--text-main); font-weight: bold; }
        h4 { font-size: 15px; margin: 0 0 10px 0; font-weight: bold; }

        label { display: block; margin-top: 10px; font-size: 13px; color: #555; font-weight: 500; }
        
        input[type="range"] { width: 100%; cursor: pointer; }
        input[type="number"], select {
            width: 100%;
            padding: 6px 8px;
            margin-top: 4px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 13px;
        }
        
        /* åªè¯»è¾“å…¥æ¡†æ ·å¼ */
        .input-readonly { background-color: #e9ecef; color: #555; font-weight: bold; border: 1px solid #ced4da; cursor: not-allowed; }

        .staff-calc-group { background-color: #f9f9f9; padding: 12px; border-radius: 6px; border: 1px solid #eee; margin-bottom: 15px; }
        .staff-calc-group h5 { margin: 0 0 8px 0; font-size: 13px; color: #333; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
        .calc-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .calc-row label { margin: 0; font-size: 12px; color: #666; }
        .calc-row input { width: 70px; text-align: right; }
        .calc-result-row { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0; }
        .calc-result-row label { font-weight: bold; color: #333; }
        .calc-result-row input { color: #2980b9; width: 70px; text-align: right; font-weight: bold; }

        #project-select { padding: 10px; font-size: 16px; color: white; background-color: var(--roche-blue); border: none; border-radius: 6px; margin-bottom: 20px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #project-select option { background-color: white; color: #333; }

        .columns { display: flex; gap: 20px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 320px; }

        .card { background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px; transition: box-shadow 0.2s; }
        .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        .view-roche .card-header-cold { border-left: 5px solid var(--roche-blue); padding-left: 10px; margin-bottom: 15px; }
        .view-roche .card-header-amb { border-left: 5px solid var(--roche-sand); padding-left: 10px; margin-bottom: 15px; }
        .view-device .card-header { border-left: 5px solid var(--device-green); padding-left: 10px; margin-bottom: 15px; }
        .view-medicine .card-header { border-left: 5px solid var(--medicine-purple); padding-left: 10px; margin-bottom: 15px; }

        .dashboard { display: flex; gap: 15px; width: 100%; flex-wrap: nowrap; align-items: stretch; flex-shrink: 0; }
        #dash-roche-group { display: flex; gap: 15px; flex: 2; }
        #dash-device-group, #dash-medicine-group { flex: 2; display: flex; }
        .dash-card { flex: 1; padding: 15px 5px; background: white; border-radius: 8px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.05); min-width: 0; }
        .dash-total { flex: 1; border-top: 5px solid #C6A4A4; background: #FFF9F9; }

        .metric-val { font-size: 28px; font-weight: bold; margin: 5px 0; white-space: nowrap; }
        .metric-sub { font-size: 12px; color: var(--text-sub); }

        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        /* åº•éƒ¨å›¾è¡¨ */
        .chart-container { background: white; padding: 25px; border-radius: 8px; margin-top: 20px; border: 1px solid var(--border-color); }
        .chart-row { display: flex; align-items: center; margin-bottom: 10px; font-size: 13px; }
        .chart-label { width: 200px; text-align: right; padding-right: 15px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 0; }
        .chart-bar-area { flex: 1; background: #f0f0f0; height: 24px; border-radius: 4px; overflow: hidden; }
        .chart-bar { height: 100%; border-radius: 4px; display: flex; align-items: center; padding-left: 10px; color: white; font-size: 12px; white-space: nowrap;}
        .chart-val { width: 120px; padding-left: 10px; font-weight: bold; color: #333; flex-shrink: 0; text-align: left; }

        .hidden { display: none !important; }
        
        .btn { background-color: #5C6E7D; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 20px; margin-bottom: 30px; font-weight: bold; font-size: 14px; transition: all 0.2s; }
        .btn:hover { background-color: #4a5a6a; transform: translateY(-1px); }
        .btn-link { background-color: #95a5a6; margin-top: 10px; font-size: 12px; padding: 8px; }
        
        /* æ¸…é™¤æŒ‰é’®æ ·å¼ */
        .btn-clear { background-color: white; color: #c0392b; border: 1px solid #e74c3c; margin-bottom: 10px; }
        .btn-clear:hover { background-color: #fcebe9; transform: translateY(-1px); }

        /* PDF éšè—åŸŸ */
        #pdf-container { position: fixed; left: -9999px; top: 0; width: 900px; background: white; padding: 40px; box-sizing: border-box; font-family: "Microsoft YaHei", sans-serif; color: #333; }
        .pdf-header { border-bottom: 4px solid #5C6E7D; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end; }
        .pdf-title { font-size: 26px; font-weight: bold; color: #2C3E50; }
        .pdf-date { font-size: 14px; color: #7F8C8D; }
        .pdf-decision-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .pdf-kpi-card { flex: 1; padding: 15px; border-radius: 6px; text-align: center; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .pdf-kpi-title { font-size: 14px; opacity: 0.9; margin-bottom: 5px; }
        .pdf-kpi-val { font-size: 32px; font-weight: bold; }
        .pdf-kpi-sub { font-size: 12px; opacity: 0.8; margin-top: 5px; }
        .pdf-resource-bar { background: #f4f6f7; border: 1px solid #ddd; border-radius: 6px; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; font-size: 13px; }
        .pdf-res-item strong { color: #2C3E50; }
        .pdf-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px; align-items: start; }
        .pdf-col-title { font-size: 16px; font-weight: bold; color: #5C6E7D; border-bottom: 2px solid #eee; padding-bottom: 8px; margin-bottom: 10px; }
        .pdf-task-group { margin-bottom: 12px; break-inside: avoid; }
        .pdf-group-name { font-size: 13px; font-weight: bold; color: #2C3E50; margin-bottom: 4px; background:#eef; padding:2px 5px; display:inline-block; border-radius:3px; }
        .pdf-task-item { display: flex; justify-content: space-between; font-size: 12px; color: #555; border-bottom: 1px dashed #eee; padding: 3px 0; }
        .pdf-task-name { font-weight: 500; }
        .pdf-chart-section { margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px; }
        .pdf-chart-title { font-size: 14px; font-weight: bold; color: #7F8C8D; margin-bottom: 10px; }

        /* === æ’ç­æ²™ç›˜æ ·å¼ (V14.1 æ»šåŠ¨æ¡ä¼˜åŒ–ç‰ˆ) === */
        .scheduler-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .scheduler-content { width: 95%; height: 90%; background: #fdfcfb; border-radius: 12px; display: flex; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; border: 4px solid white; }
        .res-pool-panel { width: 280px; background: #eaeded; padding: 15px; display: flex; flex-direction: column; border-right: 2px solid #ccc; flex-shrink: 0; }
        .pool-container { flex: 1; background: white; border: 2px dashed #bdc3c7; border-radius: 6px; padding: 10px; overflow-y: auto; align-content: flex-start; display: flex; flex-wrap: wrap; gap: 8px; }
        .schedule-board { flex: 1; padding: 20px; overflow-y: auto; background: white; display: flex; gap: 20px; }
        .schedule-col { flex: 1; display: flex; flex-direction: column; gap: 15px; height: 100%; }
        
        .schedule-zone { 
            background: #f8f9fa; 
            border: 2px dashed #dcdfe6; 
            border-radius: 8px; 
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
        }
        
        /* å†…éƒ¨æ”¾å°äººçš„ç›’å­ï¼šåŸºç¡€æ ·å¼ (V15.4 ä¿®å¤ç‰ˆ) */
        .zone-box { 
            background: transparent; 
            border: none !important; /* â˜… ä¿®å¤ï¼šå»æ‰å†…è¾¹æ¡† */
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            align-content: flex-start; 
            width: 100% !important;  /* â˜… ä¿®å¤ï¼šå¼ºåˆ¶æ’‘å¼€ */
            padding-right: 5px; 
        }
        
        /* æœ¬ç»„å‡ºå‹¤ (æ·¡ç´«è‰² + å¤§ç©ºé—´ + æ»šåŠ¨æ¡) */
        .zone-base-container .schedule-zone { 
            background: #f3e5f5; border-color: #ce93d8; flex: 2; 
        }
        .zone-base-container .zone-box {
            min-height: 250px; max-height: 450px; overflow-y: auto;
        }

        /* æ”¯æ´äººå‘˜ (æ·¡æ©™è‰² + è¾ƒå°ç©ºé—´) */
        .zone-sup-container .schedule-zone { 
            background: #fff3e0; border-color: #ffcc80; flex: 1; 
        }
        .zone-sup-container .zone-box {
            min-height: 100px; max-height: 150px; overflow-y: auto;
        }

        /* ç¼ºå£åŒºåŸŸ */
        .zone-gap-container .schedule-zone {
            background: #fff0f0; border-color: #fadbd8; flex: 0 0 auto;
        }
        .zone-gap-container .zone-box {
            min-height: 60px;
        }

        .zone-title { font-weight: bold; margin-bottom: 8px; font-size: 14px; display: flex; justify-content: space-between; color: #555; }
        .zone-box::-webkit-scrollbar { width: 6px; }
        .zone-box::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 3px; }
        
        /* äººå‘˜å¡ç‰‡ */
        .staff-card { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; color: white; cursor: grab; display: inline-flex; align-items: center; gap: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); user-select: none; position: relative; height: 24px; }
        .staff-card:active { cursor: grabbing; transform: scale(1.05); }
        .staff-type-1 { background: #3498db; }
        .staff-type-2 { background: #27ae60; }
        .staff-type-3 { background: #f1c40f; color: #333; }
        .staff-delete { display: none; width: 16px; height: 16px; background: rgba(0,0,0,0.2); border-radius: 50%; text-align: center; line-height: 14px; font-size: 10px; cursor: pointer; margin-left: 5px; }
        .staff-card:hover .staff-delete { display: inline-block; }
        
        .gap-block { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; color: white; background: #e74c3c; opacity: 0.8; border: 1px dashed white; cursor: not-allowed; }
        .add-staff-area { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #ccc; }
        .add-staff-area textarea { width: 100%; height: 60px; margin-bottom: 5px; font-size: 12px; padding: 5px; border-radius: 4px; border:1px solid #ccc; }
        .type-radio { font-size: 12px; margin-right: 8px; cursor: pointer; }

        /* === V15.3 ç»ˆæ PDF æŠ¥è¡¨æ ·å¼ (å®½å±æˆªå›¾é€‚é…) === */
        .pdf-mode-active {
            display: block !important;
            background: white !important;
            box-shadow: none !important;
            border: none !important;
            padding: 0 !important;
            position: absolute !important;
            top: 0;
            left: 0;
            z-index: -9999;
            min-width: 1280px !important; /* å¼ºåˆ¶å®½å± */
        }
        
        /* éšè—æ‚é¡¹ */
        .pdf-mode-active .res-pool-panel,
        .pdf-mode-active .add-staff-area,
        .pdf-mode-active .staff-delete,
        .pdf-mode-active .scheduler-content > button { 
            display: none !important; 
        }

        /* ä¸»ä½“å®¹å™¨ï¼šå·¦å³å¸ƒå±€ï¼Œæ’‘æ»¡ */
        .pdf-mode-active .schedule-board {
            width: 100% !important;
            padding: 20px 40px !important;
            margin: 0 !important;
            background: white !important;
            display: flex !important; /* Flex å¸ƒå±€ */
            gap: 30px !important;
            align-items: flex-start !important;
        }

        .pdf-mode-active #sched-view-roche {
            display: flex !important;
            flex-direction: row !important; /* å·¦å³æ’åˆ— */
            width: 100% !important;
            gap: 30px !important;
        }

        .pdf-mode-active .schedule-col {
            flex: 1 !important;
            border: none !important;
            padding: 0 !important;
            height: auto !important;
            width: auto !important;
        }

        /* ç›’å­å…¨å±•å¼€ */
        .pdf-mode-active .schedule-zone,
        .pdf-mode-active .zone-box {
            max-height: none !important;
            min-height: 80px !important;
            overflow: visible !important;
            height: auto !important;
            display: flex !important;
            flex-wrap: wrap !important;
            background: #fff !important;
            border: 1px solid #ddd !important;
            margin-bottom: 15px;
        }

        .pdf-mode-active .zone-gap-container {
            display: block !important;
            height: auto !important;
        }

        .pdf-mode-active h3 {
            color: #2c3e50 !important;
            border-bottom: 2px solid #7f8c8d;
            padding-bottom: 10px;
            margin-top: 0 !important;
            margin-bottom: 20px;
            font-size: 20px !important;
            text-align: center;
        }

        @media print {
            body { height: auto; overflow: visible; display: block; }
            .sidebar, .btn { display: none; }
            .chart-container { break-inside: avoid; }
            .main-content { height: auto; overflow: visible; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <label style="margin-top:0">ğŸ“Š é€‰æ‹©é¡¹ç›®ç»„</label>
        <select id="project-select" onchange="switchView()">
            <option value="roche">ğŸ’Š ç½—è¯Š (Roche)</option>
            <option value="device">âš™ï¸ å™¨æ¢° (Device)</option>
            <option value="medicine">ğŸŒ¿ è¯å“ (Medicine)</option>
        </select>

        <h2>âš™ï¸ å†³ç­–å‚æ•°</h2>
        <label>ä¸´æ—¶å·¥æ•ˆç‡ç³»æ•° <span id="disp_eff" style="float:right; font-weight:bold;">1.00</span></label>
        <input type="range" id="eff" min="0.1" max="1.0" step="0.05" value="1.0" oninput="update()">
        <label>OEE (æœ‰æ•ˆä½œä¸šç‡) <span id="disp_oee" style="float:right; font-weight:bold;">1.00</span></label>
        <input type="range" id="oee" min="0.1" max="1.0" step="0.05" value="1.0" oninput="update()">
        
        <div id="shift-group-roche" class="hidden">
            <label>â±ï¸ ç­æ¬¡æ—¶é•¿ (ç½—è¯Šä¸“å±)</label>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="font-size:12px; color:#666; line-height:28px;">â„ï¸å†·é“¾:</span>
                <input type="number" id="shift_roche_cold" value="8" min="1" max="24" step="0.5" oninput="update()" style="width:60px; text-align:right;">
            </div>
            <div style="display:flex; justify-content:space-between;">
                <span style="font-size:12px; color:#666; line-height:28px;">â˜€ï¸å¸¸æ¸©:</span>
                <input type="number" id="shift_roche_amb" value="8" min="1" max="24" step="0.5" oninput="update()" style="width:60px; text-align:right;">
            </div>
        </div>

        <div id="shift-group-generic">
            <label>â±ï¸ ç­æ¬¡æ—¶é•¿ (é€šç”¨)</label>
            <div style="display:flex; align-items:center; gap:10px;">
                <input type="number" id="shift_generic" value="8" min="1" max="24" step="0.5" oninput="update()" style="font-size:14px; font-weight:bold; color:var(--device-green);">
                <span style="font-size:12px; color:#999;">H / ç­</span>
            </div>
        </div>

        <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee;">
            <h3>ğŸ‘¥ æ­£å¼å·¥å‡ºå‹¤è®¡ç®—</h3>
            <button class="btn" onclick="openScheduler()" style="margin: 5px 0 15px 0; background: #8e44ad; padding: 8px; font-size: 13px;">ğŸ§© æ‰“å¼€äººå‘˜æ’ç­æ²™ç›˜ (ç‚¹å)</button>
            
            <div id="formal-roche">
                <div class="staff-calc-group">
                    <h5>â„ï¸ ç½—è¯Šå†·é“¾ç»„</h5>
                    <div class="calc-row">
                        <label>ğŸ  æœ¬ç»„å‡ºå‹¤</label>
                        <input type="number" id="base_roche_cold" class="staff-base input-readonly" readonly style="pointer-events: none; background-color: #e9ecef;" min="0" value="0">
                    </div>
                    <div class="calc-row">
                        <label>ğŸŸ§ æ´¾æ¥æ”¯æ´</label>
                        <input type="number" id="sup_roche_cold" class="staff-dynamic input-readonly" readonly style="pointer-events: none; background-color: #e9ecef;" min="0" value="0">
                    </div>
                    <div class="calc-result-row"><label>ã€“ å®é™…å¯ç”¨</label><input type="number" id="fc_roche_cold" class="input-readonly" readonly value="0"></div>
                </div>
                <div class="staff-calc-group">
                    <h5>â˜€ï¸ ç½—è¯Šå¸¸æ¸©ç»„</h5>
                    <div class="calc-row">
                        <label>ğŸ  æœ¬ç»„å‡ºå‹¤</label>
                        <input type="number" id="base_roche_amb" class="staff-base input-readonly" readonly style="pointer-events: none; background-color: #e9ecef;" min="0" value="0">
                    </div>
                    <div class="calc-row">
                        <label>ğŸŸ§ æ´¾æ¥æ”¯æ´</label>
                        <input type="number" id="sup_roche_amb" class="staff-dynamic input-readonly" readonly style="pointer-events: none; background-color: #e9ecef;" min="0" value="0">
                    </div>
                    <div class="calc-result-row"><label>ã€“ å®é™…å¯ç”¨</label><input type="number" id="fc_roche_amb" class="input-readonly" readonly value="0"></div>
                </div>
            </div>
            
            <div id="formal-device" class="hidden">
                <div class="staff-calc-group">
                    <h5>âš™ï¸ å™¨æ¢°ç»„</h5>
                    <div class="calc-row">
                        <label>ğŸ  æœ¬ç»„å‡ºå‹¤</label>
                        <input type="number" id="base_device" class="staff-base input-readonly" readonly style="pointer-events: none; background-color: #e9ecef;" min="0" value="0">
                    </div>
                    <div class="calc-row">
                        <label>ğŸŸ§ æ´¾æ¥æ”¯æ´</label>
                        <input type="number" id="sup_device" class="staff-dynamic input-readonly" readonly style="pointer-events: none; background-color: #e9ecef;" min="0" value="0">
                    </div>
                    <div class="calc-result-row"><label>ã€“ å®é™…å¯ç”¨</label><input type="number" id="fc_device" class="input-readonly" readonly value="0"></div>
                </div>
            </div>

            <div id="formal-medicine" class="hidden">
                <div class="staff-calc-group">
                    <h5>ğŸŒ¿ è¯å“ç»„</h5>
                    <div class="calc-row">
                        <label>ğŸ  æœ¬ç»„å‡ºå‹¤</label>
                        <input type="number" id="base_medicine" class="staff-base input-readonly" readonly style="pointer-events: none; background-color: #e9ecef;" min="0" value="0">
                    </div>
                    <div class="calc-row">
                        <label>ğŸŸ§ æ´¾æ¥æ”¯æ´</label>
                        <input type="number" id="sup_medicine" class="staff-dynamic input-readonly" readonly style="pointer-events: none; background-color: #e9ecef;" min="0" value="0">
                    </div>
                    <div class="calc-result-row"><label>ã€“ å®é™…å¯ç”¨</label><input type="number" id="fc_medicine" class="input-readonly" readonly value="0"></div>
                </div>
            </div>
        </div>

        <div style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
            <button class="btn btn-clear" onclick="clearData()">ğŸ—‘ï¸ ä¸€é”®æ¸…é™¤ä»Šæ—¥ä¸šåŠ¡æ•°æ®</button>
            <button class="btn" onclick="generatePDF()" style="background-color: #e74c3c;">ğŸ“„ ç”Ÿæˆæ±‡æŠ¥ PDF</button>
            <div id="pdf-msg" style="font-size:12px; color:#c0392b; text-align:center; display:none;">ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...</div>
            <button class="btn btn-link" onclick="generateLink()">ğŸ”— ä»…ç”Ÿæˆé“¾æ¥</button>
            <div id="link-msg" style="font-size:12px; color:#27ae60; text-align:center; display:none;">é“¾æ¥å·²å¤åˆ¶</div>
        </div>
    </div>

    <div class="main-content">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom: 2px solid #eee; padding-bottom: 10px;">
            <div>
                <h1 id="page-title">ç½—è¯Šé¡¹ç›®äººåŠ›æ’ç­å†³ç­–æ¨¡å‹</h1>
                <div style="color:var(--text-sub); font-size:14px;">Tianma Logistics Park Staffing Model</div>
            </div>
            <div style="text-align:right;">
                <h3 id="currentDate" style="color:#5C6E7D; margin:0;"></h3>
            </div>
        </div>

        <div class="dashboard">
            <div id="dash-roche-group">
                <div class="dash-card" style="border-top: 5px solid var(--roche-blue); background: #F4F7F9;">
                    <h4 style="color:#2C3E50">â„ï¸ å†·é“¾éœ€æ±‚</h4>
                    <div class="metric-val" id="res_roche_cold">0 äºº</div>
                    <div class="metric-sub">ç¼ºå£: <span id="gap_roche_cold">0.0</span> H</div>
                </div>
                <div class="dash-card" style="border-top: 5px solid var(--roche-sand); background: #F9F7F5; margin-left: 15px;">
                    <h4 style="color:#5D5046">â˜€ï¸ å¸¸æ¸©éœ€æ±‚</h4>
                    <div class="metric-val" id="res_roche_amb">0 äºº</div>
                    <div class="metric-sub">ç¼ºå£: <span id="gap_roche_amb">0.0</span> H</div>
                </div>
            </div>
            <div id="dash-device-group" class="hidden">
                <div class="dash-card" style="border-top: 5px solid var(--device-green); background: var(--device-bg); width: 100%;">
                    <h4 style="color:#556B2F">âš™ï¸ å™¨æ¢°ç»„éœ€æ±‚</h4>
                    <div class="metric-val" id="res_device">0 äºº</div>
                    <div class="metric-sub">ç¼ºå£: <span id="gap_device">0.0</span> H</div>
                </div>
            </div>
            <div id="dash-medicine-group" class="hidden">
                <div class="dash-card" style="border-top: 5px solid var(--medicine-purple); background: var(--medicine-bg); width: 100%;">
                    <h4 style="color:#555">ğŸŒ¿ è¯å“ç»„éœ€æ±‚</h4>
                    <div class="metric-val" id="res_medicine">0 äºº</div>
                    <div class="metric-sub">ç¼ºå£: <span id="gap_medicine">0.0</span> H</div>
                </div>
            </div>
            <div class="dash-card dash-total">
                <h4 style="color:#922B21">ğŸ† ä»Šæ—¥æ€»éœ€æ±‚</h4>
                <div class="metric-val" style="color:#922B21" id="res_total">0 äºº</div>
                <div class="metric-sub">ç­æ¬¡: <span id="res_shift">8</span> H</div>
            </div>
        </div>

        <div id="view-roche" class="columns view-roche">
            <div class="col">
                <div style="background:var(--roche-blue); color:white; padding:10px; border-radius:6px; margin-bottom:15px; font-weight:bold;">â„ï¸ ç½—è¯Šå†·é“¾ç»„</div>
                <div class="card"><div class="card-header-cold"><h4>ğŸ“¦ ç½—è¯Šå†·é“¾ (ä¸»è¥)</h4></div><div class="input-grid">
                    <div class="input-item"><label>æ”¶è´§ç¿»æ‰˜/å…¨æ£€ (æ‰˜)</label><input type="number" class="data-input" data-uph="2.5" id="c_ft"></div>
                    <div class="input-item"><label>æ”¶è´§ä¸Šæ¶ (æ¡)</label><input type="number" class="data-input" data-uph="20" id="c_sj"></div>
                    <div class="input-item"><label>å‘è´§æ‹£è´§ (æ¡)</label><input type="number" class="data-input" data-uph="20" id="c_jh"></div>
                    <div class="input-item"><label>æ‰«æåŒ…è£… (ç›’)</label><input type="number" class="data-input" data-uph="110" id="c_bz"></div>
                    <div class="input-item"><label>æ‹†å°è“ç®± (ä¸ª)</label><input type="number" class="data-input" data-uph="13" id="c_lx"></div>
                    <div class="input-item"><label>æ¸©åº¦è®¡ä¸‹è½½ (ä¸ª)</label><input type="number" class="data-input" data-uph="30" id="c_lxx"></div>
                </div></div>
                <div class="card"><div class="card-header-cold"><h4>ğŸ§Š å®‰æ·ä¼¦(å†·é“¾)</h4></div><div class="input-grid">
                    <div class="input-item"><label>æ”¶è´§ä¸Šæ¶ (æ¡)</label><input type="number" class="data-input" data-uph="20" id="ag_sj"></div>
                    <div class="input-item"><label>å‘è´§æ‹£è´§ (æ¡)</label><input type="number" class="data-input" data-uph="20" id="ag_jh"></div>
                    <div class="input-item"><label>æ‰«æåŒ…è£… (ç›’)</label><input type="number" class="data-input" data-uph="75" id="ag_bz"></div>
                </div></div>
                <div class="card"><div class="card-header-cold"><h4>ğŸ§Š è±ªæ´›æ·(å†·é“¾)</h4></div><div class="input-grid">
                    <div class="input-item"><label>æ”¶è´§ä¸Šæ¶ (æ¡)</label><input type="number" class="data-input" data-uph="20" id="ho_sj"></div>
                    <div class="input-item"><label>å‘è´§æ‹£è´§ (æ¡)</label><input type="number" class="data-input" data-uph="20" id="ho_jh"></div>
                </div></div>
                <div class="card"><div class="card-header-cold"><h4>ğŸ§Š ç½—è¯Šè‡ªè¥</h4></div><div class="input-grid">
                    <div class="input-item"><label>æ”¶è´§ä¸Šæ¶ (æ¡)</label><input type="number" class="data-input" data-uph="20" id="se_sj"></div>
                    <div class="input-item"><label>å‘è´§æ‹£è´§ (æ¡)</label><input type="number" class="data-input" data-uph="20" id="se_jh"></div>
                    <div class="input-item"><label>æ‰«æåŒ…è£… (ç›’)</label><input type="number" class="data-input" data-uph="75" id="se_bz"></div>
                </div></div>
                <div class="card"><div class="card-header-cold"><h4>ğŸ” åŠ¨æ€ç›˜ç‚¹</h4></div><div class="input-grid">
                    <div class="input-item"><label>å†·é“¾ç›˜ç‚¹ (æ¡)</label><input type="number" class="data-input" data-uph="20" id="c_pd"></div>
                </div></div>
            </div>
            
            <div class="col">
                <div style="background:var(--roche-sand); color:#5D5046; padding:10px; border-radius:6px; margin-bottom:15px; font-weight:bold;">â˜€ï¸ ç½—è¯Šå¸¸æ¸©ç»„</div>
                <div class="card"><div class="card-header-amb"><h4>ğŸ§ª ç½—æ°è¯•å‰‚</h4></div><div class="input-grid">
                    <div class="input-item"><label>ä¸Šæ¶ (æ¡)</label><input type="number" class="data-input" data-uph="13" data-subtype="amb" id="r_sj"></div>
                    <div class="input-item"><label>å–è´§ (æ¡)</label><input type="number" class="data-input" data-uph="13" data-subtype="amb" id="r_qh"></div>
                    <div class="input-item"><label>æ‰«æåŒ…è£… (ç›’)</label><input type="number" class="data-input" data-uph="120" data-subtype="amb" id="r_bz"></div>
                    <div class="input-item"><label>è½¬å‚¨ (æ¡)</label><input type="number" class="data-input" data-uph="13" data-subtype="amb" id="r_zc"></div>
                </div></div>
                <div class="card"><div class="card-header-amb"><h4>ğŸ”¬ ç½—æ°ä»ªå™¨</h4></div><div class="input-grid">
                    <div class="input-item"><label>å›½å†…åˆ°è´§æ¸…ç‚¹ (ç›’)</label><input type="number" class="data-input" data-uph="80" data-subtype="amb" id="i_qd"></div>
                    <div class="input-item"><label>ä¸Šæ¶ (æ¡)</label><input type="number" class="data-input" data-uph="13" data-subtype="amb" id="i_sj"></div>
                    <div class="input-item"><label>å–è´§ (æ¡)</label><input type="number" class="data-input" data-uph="10" data-subtype="amb" id="i_qh"></div>
                    <div class="input-item"><label>æ‰«æåŒ…è£… (PC)</label><input type="number" class="data-input" data-uph="50" data-subtype="amb" id="i_bz"></div>
                    <div class="input-item"><label>è½¬å‚¨ (æ¡)</label><input type="number" class="data-input" data-uph="13" data-subtype="amb" id="i_zc"></div>
                </div></div>
                <div class="card"><div class="card-header-amb"><h4>ğŸ“¦ ç½—è¯Š2æ–¹</h4></div><div class="input-grid">
                    <div class="input-item"><label>åˆ°è´§æ¸…ç‚¹ (PC)</label><input type="number" class="data-input" data-uph="200" data-subtype="amb" id="p2_qd"></div>
                    <div class="input-item"><label>ä¸Šæ¶ (æ¡)</label><input type="number" class="data-input" data-uph="13" data-subtype="amb" id="p2_sj"></div>
                    <div class="input-item"><label>ä¸‹æ¶ (æ¡)</label><input type="number" class="data-input" data-uph="13" data-subtype="amb" id="p2_xj"></div>
                    <div class="input-item"><label>åŒ…è£… (PC)</label><input type="number" class="data-input" data-uph="100" data-subtype="amb" id="p2_bz"></div>
                    <div class="input-item"><label>è½¬å‚¨ (æ¡)</label><input type="number" class="data-input" data-uph="13" data-subtype="amb" id="p2_zc"></div>
                </div></div>
                <div class="card"><div class="card-header-amb"><h4>ğŸ¦· å£«å“æ›¼</h4></div><div class="input-grid">
                    <div class="input-item"><label>åˆ°è´§æ¸…ç‚¹ (PC)</label><input type="number" class="data-input" data-uph="200" data-subtype="amb" id="st_qd"></div>
                    <div class="input-item"><label>ä¸Šæ¶ (æ¡)</label><input type="number" class="data-input" data-uph="13" data-subtype="amb" id="st_sj"></div>
                    <div class="input-item"><label>ä¸‹æ¶ (æ¡)</label><input type="number" class="data-input" data-uph="13" data-subtype="amb" id="st_xj"></div>
                    <div class="input-item"><label>åŒ…è£… (PC)</label><input type="number" class="data-input" data-uph="200" data-subtype="amb" id="st_bz"></div>
                    <div class="input-item"><label>è½¬å‚¨ (æ¡)</label><input type="number" class="data-input" data-uph="13" data-subtype="amb" id="st_zc"></div>
                </div></div>
                <div class="card"><div class="card-header-amb"><h4>ğŸ˜· é˜²ç–«ç‰©èµ„</h4></div><div class="input-grid">
                    <div class="input-item"><label>åˆ°è´§æ¸…ç‚¹ (PC)</label><input type="number" class="data-input" data-uph="200" data-subtype="amb" id="fy_qd"></div>
                    <div class="input-item"><label>ä¸Šæ¶ (æ¡)</label><input type="number" class="data-input" data-uph="13" data-subtype="amb" id="fy_sj"></div>
                    <div class="input-item"><label>ä¸‹æ¶ (æ¡)</label><input type="number" class="data-input" data-uph="13" data-subtype="amb" id="fy_xj"></div>
                    <div class="input-item"><label>åŒ…è£… (PC)</label><input type="number" class="data-input" data-uph="400" data-subtype="amb" id="fy_bz"></div>
                    <div class="input-item"><label>è½¬å‚¨ (æ¡)</label><input type="number" class="data-input" data-uph="13" data-subtype="amb" id="fy_zc"></div>
                </div></div>
                <div class="card"><div class="card-header-amb"><h4>ğŸ¥ è¿ˆç‘</h4></div><div class="input-grid">
                    <div class="input-item"><label>åˆ°è´§æ¸…ç‚¹ (PC)</label><input type="number" class="data-input" data-uph="100" data-subtype="amb" id="mr_qd"></div>
                    <div class="input-item"><label>ä¸Šæ¶ (æ¡)</label><input type="number" class="data-input" data-uph="13" data-subtype="amb" id="mr_sj"></div>
                    <div class="input-item"><label>ä¸‹æ¶ (æ¡)</label><input type="number" class="data-input" data-uph="13" data-subtype="amb" id="mr_xj"></div>
                    <div class="input-item"><label>åŒ…è£… (PC)</label><input type="number" class="data-input" data-uph="100" data-subtype="amb" id="mr_bz"></div>
                    <div class="input-item"><label>è½¬å‚¨ (æ¡)</label><input type="number" class="data-input" data-uph="13" data-subtype="amb" id="mr_zc"></div>
                </div></div>
                <div class="card"><div class="card-header-amb"><h4>ğŸ”„ å…¶ä»–</h4></div><div class="input-grid">
                    <div class="input-item"><label>å¸¸æ¸©é€€è´§ (æ¡)</label><input type="number" class="data-input" data-uph="2" data-subtype="amb" id="oth_th"></div>
                    <div class="input-item"><label>å¸¸æ¸©ç›˜ç‚¹ (æ¡)</label><input type="number" class="data-input" data-uph="13" data-subtype="amb" id="oth_pd"></div>
                </div></div>
            </div>
        </div>

        <div id="view-device" class="columns view-device hidden">
            <div class="col">
                <div style="background:var(--device-green); color:white; padding:10px; border-radius:6px; margin-bottom:15px; font-weight:bold;">âš™ï¸ å™¨æ¢°é¡¹ç›®ç»„</div>
                <div class="card"><div class="card-header"><h4>ğŸ”© ä¸“é¡¹æ“ä½œ (SP/å¢¨å°¼å…‹/é”é€‚)</h4></div><div class="input-grid">
                    <div class="input-item"><label>SPåˆ°è´§æ¸…ç‚¹ (PC)</label><input type="number" class="data-input device-input" data-uph="200" id="d_sp_qd"></div>
                    <div class="input-item"><label>å¢¨å°¼å…‹ç¿»æ‰˜ (æ‰˜)</label><input type="number" class="data-input device-input" data-uph="20" id="d_mnk_ft"></div>
                    <div class="input-item"><label>å¢¨å°¼å…‹åŒ…è£… (ç›’)</label><input type="number" class="data-input device-input" data-uph="50" id="d_mnk_bz"></div>
                    <div class="input-item"><label>é”é€‚BOM (ç›’)</label><input type="number" class="data-input device-input" data-uph="50" id="d_rs_bom"></div>
                </div></div>
                <div class="card"><div class="card-header"><h4>ğŸ› ï¸ å™¨æ¢°é€šç”¨æ“ä½œ</h4></div><div class="input-grid">
                    <div class="input-item"><label>æ”¶è´§ä¸Šæ¶ (æ¡)</label><input type="number" class="data-input device-input" data-uph="15" id="d_sj"></div>
                    <div class="input-item"><label>å‘è´§ä¸‹æ¶ (æ¡)</label><input type="number" class="data-input device-input" data-uph="15" id="d_xj"></div>
                    <div class="input-item"><label>æ‰«æåŒ…è£… (ç›’)</label><input type="number" class="data-input device-input" data-uph="50" id="d_bz"></div>
                    <div class="input-item"><label>è´´æ ‡ (ç›’)</label><input type="number" class="data-input device-input" data-uph="100" id="d_tb"></div>
                </div></div>
            </div>
        </div>

        <div id="view-medicine" class="columns view-medicine hidden">
            <div class="col">
                <div style="background:var(--medicine-purple); color:white; padding:10px; border-radius:6px; margin-bottom:15px; font-weight:bold;">ğŸŒ¿ è¯å“é¡¹ç›®ç»„</div>
                <div class="card"><div class="card-header"><h4>ğŸ’Š è¯å“åŸºç¡€ä½œä¸š</h4></div><div class="input-grid">
                    <div class="input-item"><label>æ”¶è´§ä¸Šæ¶ (æ¡)</label><input type="number" class="data-input medicine-input" data-uph="20" id="p_sj"></div>
                    <div class="input-item"><label>å‘è´§ä¸‹æ¶ (æ¡)</label><input type="number" class="data-input medicine-input" data-uph="20" id="p_xj"></div>
                    <div class="input-item"><label>æ‰«æåŒ…è£… (æ¡)</label><input type="number" class="data-input medicine-input" data-uph="100" id="p_bz"></div>
                    <div class="input-item"><label>è´´æ ‡ (ç›’)</label><input type="number" class="data-input medicine-input" data-uph="150" id="p_tb"></div>
                </div></div>
                <div class="card"><div class="card-header"><h4>ğŸ—ï¸ è¯å“ä¸“é¡¹ä½œä¸š</h4></div><div class="input-grid">
                    <div class="input-item"><label>ç½—è´¸&ç½—è¯ç¿»æ‰˜ (æ‰˜)</label><input type="number" class="data-input medicine-input" data-uph="20" id="p_ft"></div>
                    <div class="input-item"><label>è±ªæ´›æ·æ”¶è´§ (æ‰˜)</label><input type="number" class="data-input medicine-input" data-uph="20" id="p_hlj_sh"></div>
                    <div class="input-item"><label>è±ªæ´›æ·æ‰“æ ‡ç­¾ (ä¸ª)</label><input type="number" class="data-input medicine-input" data-uph="100" id="p_hlj_tb"></div>
                    <div class="input-item"><label>ç”µå•†åˆ†åŒ… (å¥—)</label><input type="number" class="data-input medicine-input" data-uph="50" id="p_ds"></div>
                </div></div>
            </div>
        </div>

        <div class="chart-container">
            <h3 style="margin-bottom:20px;">ğŸ“Š å„ç¯èŠ‚äººåŠ›åˆ†å¸ƒæ¨è</h3>
            <div id="chart-area">
                <div style="text-align:center; color:#999; padding:20px;">æš‚æ— è¾“å…¥æ•°æ®</div>
            </div>
        </div>
    </div>

    <div id="pdf-container"></div>
    
    <div id="scheduler-modal" class="scheduler-modal">
        <div class="scheduler-content" id="scheduler-capture-area">
            <div class="res-pool-panel">
                <h4 style="margin-top:0">ğŸ—‚ï¸ äººå‘˜èµ„æºæ± </h4>
                <div class="add-staff-area">
                    <textarea id="new-staff-names" placeholder="æ‰¹é‡æ·»åŠ å§“å (ç©ºæ ¼éš”å¼€)"></textarea>
                    <div style="margin-bottom:5px;">
                        <label class="type-radio"><input type="radio" name="staffType" value="1" checked>ğŸŸ¦ç®¡ç†</label>
                        <label class="type-radio"><input type="radio" name="staffType" value="2">ğŸŸ©ä¸€çº¿</label>
                        <label class="type-radio"><input type="radio" name="staffType" value="3">ğŸŸ¨ä¸´æ—¶</label>
                    </div>
                    <button class="btn" onclick="addNewStaff()" style="margin:0; padding:6px; background:#2c3e50;">â• æ‰¹é‡å…¥æ± </button>
                </div>
                <div style="font-size:12px; color:#666; margin-bottom:5px;">æ‹–æ‹½äººå‘˜åˆ°å³ä¾§æ’ç­ (ç‚¹å‡»Xå›æ± )</div>
                <div id="pool-container" class="pool-container"></div>
            </div>

            <div class="schedule-board">
                <div id="sched-view-roche" class="schedule-col hidden" style="display:flex; flex-direction:row; width:100%;">
                    <div class="schedule-col" style="border-right:2px solid #eee; padding-right:10px;">
                        <h3 style="color:var(--roche-blue)">â„ï¸ å†·é“¾ç»„æ’ç­</h3>
                        <div class="schedule-zone zone-base-container">
                            <div class="zone-title">ğŸ  æœ¬ç»„å‡ºå‹¤ <span id="count-roche-cold-base">0</span></div>
                            <div id="zone_roche_cold_base" class="zone-box sortable-zone" data-target="base_roche_cold"></div>
                        </div>
                        <div class="schedule-zone zone-sup-container">
                            <div class="zone-title">ğŸŸ§ æ”¯æ´äººå‘˜ <span id="count-roche-cold-sup">0</span></div>
                            <div id="zone_roche_cold_sup" class="zone-box sortable-zone" data-target="sup_roche_cold"></div>
                        </div>
                        <div class="schedule-zone zone-gap-container" style="background:#fff0f0; border-color:#fadbd8">
                            <div class="zone-title" style="color:#c0392b">ğŸŸ¥ äººå‘˜ç¼ºå£ (è‡ªåŠ¨ç”Ÿæˆ)</div>
                            <div id="gap_roche_cold_area" class="zone-box" style="border:none; background:transparent;"></div>
                        </div>
                    </div>
                    <div class="schedule-col" style="padding-left:10px;">
                        <h3 style="color:var(--roche-sand)">â˜€ï¸ å¸¸æ¸©ç»„æ’ç­</h3>
                        <div class="schedule-zone zone-base-container">
                            <div class="zone-title">ğŸ  æœ¬ç»„å‡ºå‹¤ <span id="count-roche-amb-base">0</span></div>
                            <div id="zone_roche_amb_base" class="zone-box sortable-zone" data-target="base_roche_amb"></div>
                        </div>
                        <div class="schedule-zone zone-sup-container">
                            <div class="zone-title">ğŸŸ§ æ”¯æ´äººå‘˜ <span id="count-roche-amb-sup">0</span></div>
                            <div id="zone_roche_amb_sup" class="zone-box sortable-zone" data-target="sup_roche_amb"></div>
                        </div>
                        <div class="schedule-zone zone-gap-container" style="background:#fff0f0; border-color:#fadbd8">
                            <div class="zone-title" style="color:#c0392b">ğŸŸ¥ äººå‘˜ç¼ºå£ (è‡ªåŠ¨ç”Ÿæˆ)</div>
                            <div id="gap_roche_amb_area" class="zone-box" style="border:none; background:transparent;"></div>
                        </div>
                    </div>
                </div>

                <div id="sched-view-generic" class="schedule-col hidden">
                    <h3 id="sched-generic-title">âš™ï¸ é¡¹ç›®ç»„æ’ç­</h3>
                    <div class="schedule-zone zone-base-container">
                        <div class="zone-title">ğŸ  æœ¬ç»„å‡ºå‹¤ <span id="count-generic-base">0</span></div>
                        <div id="zone_generic_base" class="zone-box sortable-zone"></div>
                    </div>
                    <div class="schedule-zone zone-sup-container">
                        <div class="zone-title">ğŸŸ§ æ”¯æ´äººå‘˜ <span id="count-generic-sup">0</span></div>
                        <div id="zone_generic_sup" class="zone-box sortable-zone"></div>
                    </div>
                    <div class="schedule-zone zone-gap-container" style="background:#fff0f0; border-color:#fadbd8">
                        <div class="zone-title" style="color:#c0392b">ğŸŸ¥ äººå‘˜ç¼ºå£ (è‡ªåŠ¨ç”Ÿæˆ)</div>
                        <div id="gap_generic_area" class="zone-box" style="border:none; background:transparent;"></div>
                    </div>
                </div>
            </div>
            
            <button onclick="closeScheduler()" class="scheduler-close-btn" style="position:absolute; top:10px; right:10px; width:40px; height:40px; background:#e74c3c; color:white; border:none; border-radius:50%; font-size:20px; cursor:pointer;">Ã—</button>
        </div>
    </div>

<script>
    const date = new Date();
    const dateStr = date.getFullYear() + "å¹´" + (date.getMonth() + 1) + "æœˆ" + date.getDate() + "æ—¥";
    document.getElementById('currentDate').innerText = dateStr;

    let currentProject = 'roche';
    
    // å…¨å±€æ•°æ®ç»“æ„ï¼šå­˜å‚¨æ‰€æœ‰äººå‘˜
    let staffData = {
        pool: [], // èµ„æºæ±  {id, name, type}
        roche_cold_base: [], roche_cold_sup: [],
        roche_amb_base: [], roche_amb_sup: [],
        device_base: [], device_sup: [],
        medicine_base: [], medicine_sup: []
    };

    function calcStaff() {
        // ç”±äºåˆ é™¤äº†ç¼ºå‹¤è¡Œï¼Œè¿™é‡Œå®é™…ä¸Šåªéœ€è¦è®¡ç®— base + sup
        const groups = ['roche_cold', 'roche_amb', 'device', 'medicine'];
        groups.forEach(g => {
            const base = parseInt(document.getElementById('base_' + g)?.value) || 0;
            // ç¼ºå‹¤é»˜è®¤ä¸º0 (å› ä¸ºHTMLåˆ äº†)
            const abs = 0; 
            const sup = parseInt(document.getElementById('sup_' + g)?.value) || 0;
            const actual = Math.max(0, base - abs + sup);
            const targetInput = document.getElementById('fc_' + g);
            if(targetInput) targetInput.value = actual;
        });
    }

    function switchView() {
        const select = document.getElementById('project-select');
        currentProject = select.value;
        const pageTitle = document.getElementById('page-title');
        
        // ç­æ¬¡æ˜¾ç¤ºæ§åˆ¶
        const groupRoche = document.getElementById('shift-group-roche');
        const groupGeneric = document.getElementById('shift-group-generic');

        if (currentProject === 'roche') {
            if(groupRoche) groupRoche.classList.remove('hidden');
            if(groupGeneric) groupGeneric.classList.add('hidden');
            pageTitle.innerText = "ç½—è¯Šé¡¹ç›®äººåŠ›æ’ç­å†³ç­–æ¨¡å‹";
            select.style.backgroundColor = "var(--roche-blue)";
        } else {
            if(groupRoche) groupRoche.classList.add('hidden');
            if(groupGeneric) groupGeneric.classList.remove('hidden');
            if (currentProject === 'device') {
                pageTitle.innerText = "å™¨æ¢°é¡¹ç›®äººåŠ›æ’ç­å†³ç­–æ¨¡å‹";
                select.style.backgroundColor = "var(--device-green)";
            } else {
                pageTitle.innerText = "è¯å“é¡¹ç›®äººåŠ›æ’ç­å†³ç­–æ¨¡å‹";
                select.style.backgroundColor = "var(--medicine-purple)";
            }
        }

        // åŒºåŸŸæ˜¾ç¤ºæ§åˆ¶
        document.getElementById('view-roche').classList.add('hidden');
        document.getElementById('view-device').classList.add('hidden');
        document.getElementById('view-medicine').classList.add('hidden');
        
        document.getElementById('formal-roche').classList.add('hidden');
        document.getElementById('formal-device').classList.add('hidden');
        document.getElementById('formal-medicine').classList.add('hidden');

        document.getElementById('dash-roche-group').classList.add('hidden');
        document.getElementById('dash-device-group').classList.add('hidden');
        document.getElementById('dash-medicine-group').classList.add('hidden');

        if (currentProject === 'roche') {
            document.getElementById('view-roche').classList.remove('hidden');
            document.getElementById('formal-roche').classList.remove('hidden');
            document.getElementById('dash-roche-group').classList.remove('hidden');
            document.getElementById('dash-roche-group').style.display = 'flex'; 
        } else if (currentProject === 'device') {
            document.getElementById('view-device').classList.remove('hidden');
            document.getElementById('formal-device').classList.remove('hidden');
            document.getElementById('dash-device-group').classList.remove('hidden');
            document.getElementById('dash-device-group').style.display = 'flex';
        } else if (currentProject === 'medicine') {
            document.getElementById('view-medicine').classList.remove('hidden');
            document.getElementById('formal-medicine').classList.remove('hidden');
            document.getElementById('dash-medicine-group').classList.remove('hidden');
            document.getElementById('dash-medicine-group').style.display = 'flex';
        }
        update(); 
    }

/* === V16.1 åˆå§‹åŒ– (æ”¯æŒè¯»å–æ’ç­é“¾æ¥ + æ™ºèƒ½åˆå¹¶) === */
    function init() {
        const params = new URLSearchParams(window.location.search);
        
        // 1. å…ˆåŠ è½½æœ¬åœ°æ•°æ® (ä½œä¸ºåº•åº§)
        loadStaffData();

        // 2. å°è¯•ä»é“¾æ¥åŠ è½½æ’ç­æ•°æ® (ä½œä¸ºè¡¥ä¸)
        if (params.has('sdata')) {
            try {
                // è§£ç ï¼šBase64 -> ä¸­æ–‡ -> JSON
                const compressed = params.get('sdata');
                const jsonStr = decodeURIComponent(atob(compressed));
                const linkData = JSON.parse(jsonStr);

                // â˜…â˜…â˜… æ™ºèƒ½åˆå¹¶é€»è¾‘ â˜…â˜…â˜…
                // åªæœ‰å½“é“¾æ¥é‡Œå¯¹åº”çš„æ± å­â€œæœ‰äººâ€æ—¶ï¼Œæ‰è¦†ç›–æœ¬åœ°çš„ã€‚
                // è¿™æ ·é¿å…â€œå¸¸æ¸©å“¥â€å‘æ¥çš„ç©ºå†·é“¾æ•°æ®æŠŠâ€œå†·é“¾å§â€æœ¬åœ°çš„æ•°æ®æ¸…ç©ºäº†ã€‚
                
                // éå† staffData çš„æ‰€æœ‰ key (pool, roche_cold_base, ...)
                for (let key in staffData) {
                    // å¦‚æœé“¾æ¥é‡Œè¿™ä¸ª key æœ‰æ•°æ® (ä¸”ä¸æ˜¯ç©ºæ•°ç»„)
                    if (linkData[key] && Array.isArray(linkData[key]) && linkData[key].length > 0) {
                        staffData[key] = linkData[key]; // è¦†ç›–/åˆå¹¶
                    }
                }
                
                // åˆå¹¶å®Œç«‹åˆ»ä¿å­˜åˆ°æœ¬åœ°
                saveStaffData();
                console.log("å·²ä»é“¾æ¥æˆåŠŸåˆå¹¶æ’ç­æ•°æ®");
                
            } catch (e) {
                console.error("é“¾æ¥æ’ç­æ•°æ®è§£æå¤±è´¥", e);
            }
        }

        // 3. å¤„ç†è¾“å…¥æ¡†æ•°æ® (ä¼˜å…ˆçº§ï¼šé“¾æ¥ > æœ¬åœ°è®°å¿†)
        document.querySelectorAll('input, select').forEach(el => {
            // å…ˆè¯»æœ¬åœ°
            if (el.id) {
                const storedVal = localStorage.getItem(el.id);
                if (storedVal !== null) el.value = storedVal;
            }
            // å†è¯»é“¾æ¥ (è¦†ç›–)
            if (el.id && params.has(el.id)) {
                el.value = params.get(el.id);
            }
        });
        
        if(params.has('project-select')){
            document.getElementById('project-select').value = params.get('project-select');
        }
        
        switchView(); 
    }

    function update(e) {
        calcStaff();
        
        // â˜… V16.0 å…¨å±€è‡ªåŠ¨ä¿å­˜ â˜…
        // åªè¦è¾“å…¥æ¡†å˜åŠ¨ï¼Œç«‹åˆ»æŠŠè¿™ä¸ªå€¼å­˜åˆ°æœ¬åœ°ï¼Œé˜²æ­¢æ‰‹æŠ–å…³ç½‘é¡µ
        // e.target æ˜¯å½“å‰è§¦å‘äº‹ä»¶çš„å…ƒç´ 
        if (e && e.target && e.target.id) {
            localStorage.setItem(e.target.id, e.target.value);
        } else {
            // å¦‚æœæ˜¯é€šç”¨è°ƒç”¨ï¼Œéå†æ‰€æœ‰è¾“å…¥æ¡†å­˜ä¸€é (ä¿é™©èµ·è§)
            document.querySelectorAll('input, select').forEach(el => {
                if(el.id) localStorage.setItem(el.id, el.value);
            });
        }

        const eff = parseFloat(document.getElementById('eff').value);
        const oee = parseFloat(document.getElementById('oee').value);
        
        let shiftCold = 8, shiftAmb = 8, shiftGen = 8;
        shiftCold = parseFloat(document.getElementById('shift_roche_cold').value) || 8;
        shiftAmb = parseFloat(document.getElementById('shift_roche_amb').value) || 8;
        shiftGen = parseFloat(document.getElementById('shift_generic').value) || 8;

        document.getElementById('disp_eff').innerText = eff.toFixed(2);
        document.getElementById('disp_oee').innerText = oee.toFixed(2);
        
        if(currentProject === 'roche') {
             document.getElementById('res_shift').innerText = shiftCold === shiftAmb ? shiftCold : `â„ï¸${shiftCold} / â˜€ï¸${shiftAmb}`;
        } else {
             document.getElementById('res_shift').innerText = shiftGen;
        }

        let totalNeed = 0;
        let chartData = [];
        
        if (currentProject === 'roche') {
            const capCold = shiftCold * oee * eff; 
            const capAmb = shiftAmb * oee * eff;   

            const fcCold = parseInt(document.getElementById('fc_roche_cold').value) || 0;
            const fcAmb = parseInt(document.getElementById('fc_roche_amb').value) || 0;
            let hoursCold = 0, hoursAmb = 0;

            document.querySelectorAll('#view-roche .data-input').forEach(input => {
                const val = parseInt(input.value) || 0;
                if(val > 0) {
                    const uph = parseFloat(input.dataset.uph);
                    const hours = val / uph;
                    const isAmb = input.dataset.subtype === 'amb';
                    const label = input.previousElementSibling.innerText;
                    const groupTitle = input.closest('.card').querySelector('h4').innerText.split(' ')[1] || "";
                    const fullName = groupTitle ? `${groupTitle}-${label}` : label;

                    if(isAmb) hoursAmb += hours; else hoursCold += hours;
                    
                    chartData.push({ 
                        name: fullName, 
                        hours: hours, 
                        people: hours / (isAmb ? capAmb : capCold), 
                        color: isAmb ? 'var(--roche-sand)' : 'var(--roche-blue)' 
                    });
                }
            });

            const gapCold = Math.max(0, (hoursCold / oee) - (fcCold * shiftCold));
            const gapAmb = Math.max(0, (hoursAmb / oee) - (fcAmb * shiftAmb));
            
            const needCold = Math.ceil(gapCold / capCold);
            const needAmb = Math.ceil(gapAmb / capAmb);

            document.getElementById('res_roche_cold').innerText = needCold + " äºº";
            document.getElementById('gap_roche_cold').innerText = gapCold.toFixed(1);
            document.getElementById('res_roche_amb').innerText = needAmb + " äºº";
            document.getElementById('gap_roche_amb').innerText = gapAmb.toFixed(1);
            totalNeed = needCold + needAmb;

        } else if (currentProject === 'device') {
            const capGen = shiftGen * oee * eff;
            const fc = parseInt(document.getElementById('fc_device').value) || 0;
            let totalHours = 0;
            document.querySelectorAll('#view-device .data-input').forEach(input => {
                const val = parseInt(input.value) || 0;
                if(val > 0) {
                    const uph = parseFloat(input.dataset.uph);
                    const hours = val / uph;
                    const label = input.previousElementSibling.innerText;
                    const groupTitle = input.closest('.card').querySelector('h4').innerText.split(' ')[1] || "";
                    const fullName = `${groupTitle}-${label}`;
                    totalHours += hours;
                    chartData.push({ name: fullName, hours: hours, people: hours / capGen, color: 'var(--device-green)' });
                }
            });
            const gap = Math.max(0, (totalHours / oee) - (fc * shiftGen)); 
            const need = Math.ceil(gap / capGen);
            document.getElementById('res_device').innerText = need + " äºº";
            document.getElementById('gap_device').innerText = gap.toFixed(1);
            totalNeed = need;

        } else if (currentProject === 'medicine') {
            const capGen = shiftGen * oee * eff;
            const fc = parseInt(document.getElementById('fc_medicine').value) || 0;
            let totalHours = 0;
            document.querySelectorAll('#view-medicine .data-input').forEach(input => {
                const val = parseInt(input.value) || 0;
                if(val > 0) {
                    const uph = parseFloat(input.dataset.uph);
                    const hours = val / uph;
                    const label = input.previousElementSibling.innerText;
                    const groupTitle = input.closest('.card').querySelector('h4').innerText.split(' ')[1] || "";
                    const fullName = `${groupTitle}-${label}`;
                    totalHours += hours;
                    chartData.push({ name: fullName, hours: hours, people: hours / capGen, color: 'var(--medicine-purple)' });
                }
            });
            const gap = Math.max(0, (totalHours / oee) - (fc * shiftGen)); 
            const need = Math.ceil(gap / capGen);
            document.getElementById('res_medicine').innerText = need + " äºº";
            document.getElementById('gap_medicine').innerText = gap.toFixed(1);
            totalNeed = need;
        }

        document.getElementById('res_total').innerText = totalNeed + " äºº";
        renderChart(chartData);
        syncGapBlocks(); // åŒæ­¥æ²™ç›˜çº¢å—
    }

    function renderChart(data) {
        const container = document.getElementById('chart-area');
        container.innerHTML = "";
        if (data.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">æš‚æ— è¾“å…¥æ•°æ®</div>';
            return;
        }
        data.sort((a, b) => b.hours - a.hours);
        const maxHours = data[0].hours;
        data.forEach(item => {
            const widthPct = (item.hours / maxHours) * 100;
            const peopleNum = item.people < 0.1 ? "<0.1" : item.people.toFixed(1);
            const row = document.createElement('div');
            row.className = 'chart-row';
            row.innerHTML = `<div class="chart-label" title="${item.name}">${item.name}</div>
                <div class="chart-bar-area"><div class="chart-bar" style="width: ${widthPct}%; background-color: ${item.color}">${item.hours.toFixed(1)} H</div></div>
                <div class="chart-val">æ¨è: ${peopleNum}äºº</div>`;
            container.appendChild(row);
        });
    }

    /* === V16.0 ä¸€é”®æ¸…é™¤ä¸šåŠ¡æ•°æ® === */
    function clearData() {
        if(confirm("ç¡®å®šè¦æ¸…ç©ºä»Šæ—¥å¡«å†™çš„ã€æ‰€æœ‰ä¸šåŠ¡æ•°æ®ã€‘å—ï¼Ÿ\n\næ³¨æ„ï¼šäººå‘˜æ’ç­å’ŒåŸºç¡€å‚æ•°ä¼šè¢«ä¿ç•™ã€‚")) {
            // åªæ¸…ç©ºä¸­é—´åŒºåŸŸçš„ä¸šåŠ¡è¾“å…¥æ¡† (data-input)
            document.querySelectorAll('.data-input').forEach(input => {
                input.value = ""; // æ¸…ç©ºç•Œé¢
                if(input.id) localStorage.removeItem(input.id); // æ“¦é™¤æœ¬åœ°è®°å¿†
            });
            update(); // è§¦å‘é‡ç®—ï¼Œè®©æ•°å­—å½’é›¶
        }
    }

    /* === æ’ç­æ²™ç›˜æ ¸å¿ƒé€»è¾‘ === */
    function openScheduler() {
        document.getElementById('scheduler-modal').style.display = 'flex';
        loadStaffData();
        renderScheduler();
        syncGapBlocks();
    }

    function closeScheduler() {
        document.getElementById('scheduler-modal').style.display = 'none';
        saveStaffData();
    }

    function loadStaffData() {
        const stored = localStorage.getItem('staffData_v1');
        if (stored) {
            try { staffData = JSON.parse(stored); } catch(e) { console.error(e); }
        }
        initSortable();
    }

    function saveStaffData() {
        localStorage.setItem('staffData_v1', JSON.stringify(staffData));
        updateMainInputsFromScheduler(); 
    }

    function updateMainInputsFromScheduler() {
        const map = {
            'roche_cold_base': 'base_roche_cold', 'roche_cold_sup': 'sup_roche_cold',
            'roche_amb_base': 'base_roche_amb', 'roche_amb_sup': 'sup_roche_amb',
            'device_base': 'base_device', 'device_sup': 'sup_device',
            'medicine_base': 'base_medicine', 'medicine_sup': 'sup_medicine'
        };

        for (let key in map) {
            const count = staffData[key] ? staffData[key].length : 0;
            const inputId = map[key];
            const el = document.getElementById(inputId);
            if (el) {
                el.value = count;
                // å†æ¬¡ç¡®ä¿åªè¯»çŠ¶æ€
                el.classList.add('input-readonly');
                el.readOnly = true;
                const spanId = 'count-' + key.replace(/_/g, '-');
                const countSpan = document.getElementById(spanId);
                if(countSpan) countSpan.innerText = count;
            }
        }
        update(); 
        syncGapBlocks(); 
    }

    function renderScheduler() {
        document.getElementById('sched-view-roche').classList.add('hidden');
        document.getElementById('sched-view-generic').classList.add('hidden');
        
        if (currentProject === 'roche') {
            document.getElementById('sched-view-roche').classList.remove('hidden');
            document.getElementById('sched-view-roche').style.display = 'flex';
        } else {
            document.getElementById('sched-view-generic').classList.remove('hidden');
            const title = currentProject === 'device' ? 'âš™ï¸ å™¨æ¢°ç»„æ’ç­' : 'ğŸŒ¿ è¯å“ç»„æ’ç­';
            document.getElementById('sched-generic-title').innerText = title;
            document.getElementById('zone_generic_base').id = `zone_${currentProject}_base`;
            document.getElementById('zone_generic_sup').id = `zone_${currentProject}_sup`;
            document.getElementById('count-generic-base').id = `count-${currentProject}-base`;
            document.getElementById('count-generic-sup').id = `count-${currentProject}-sup`;
        }

        const poolEl = document.getElementById('pool-container');
        poolEl.innerHTML = '';
        staffData.pool.forEach((staff, idx) => {
            poolEl.appendChild(createStaffEl(staff, 'pool', idx));
        });

        const zones = ['roche_cold_base', 'roche_cold_sup', 'roche_amb_base', 'roche_amb_sup', 'device_base', 'device_sup', 'medicine_base', 'medicine_sup'];
        zones.forEach(zoneKey => {
            const el = document.getElementById('zone_' + zoneKey);
            if(el) {
                el.innerHTML = '';
                if(staffData[zoneKey]) {
                    staffData[zoneKey].forEach((staff, idx) => {
                        el.appendChild(createStaffEl(staff, zoneKey, idx));
                    });
                }
            }
        });
        updateMainInputsFromScheduler();
    }

    function createStaffEl(staff, sourceKey, idx) {
        const div = document.createElement('div');
        div.className = `staff-card staff-type-${staff.type}`;
        div.innerHTML = `${staff.name} <span class="staff-delete" onclick="removeStaff('${sourceKey}', ${idx})">Ã—</span>`;
        div.dataset.id = staff.id; 
        return div;
    }

    function addNewStaff() {
        const input = document.getElementById('new-staff-names');
        const names = input.value.trim();
        if(!names) return;
        const type = document.querySelector('input[name="staffType"]:checked').value;
        const nameArr = names.split(/[\s,ï¼Œ]+/);
        nameArr.forEach(n => {
            if(n) {
                staffData.pool.push({
                    id: Date.now() + Math.random(),
                    name: n,
                    type: type
                });
            }
        });
        input.value = '';
        saveStaffData();
        renderScheduler();
    }

    function removeStaff(sourceKey, idx) {
        const staff = staffData[sourceKey].splice(idx, 1)[0];
        if (sourceKey !== 'pool') staffData.pool.push(staff);
        saveStaffData();
        renderScheduler();
    }

    /* === V15.0 ç¼ºå£é€»è¾‘ (ç›´æ¥è¯»å–éœ€æ±‚æ•°) === */
    function syncGapBlocks() {
        const map = {
            'gap_roche_cold_area': 'res_roche_cold',
            'gap_roche_amb_area': 'res_roche_amb',
            'gap_generic_area': currentProject === 'device' ? 'res_device' : 'res_medicine'
        };

        ['gap_roche_cold_area', 'gap_roche_amb_area', 'gap_generic_area'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = '';
        });

        for (let areaId in map) {
            if (currentProject === 'roche' && areaId === 'gap_generic_area') continue;
            if (currentProject !== 'roche' && areaId.includes('roche')) continue;

            // ç›´æ¥è¯»å–ä¸»é¡µç®—å‡ºæ¥çš„â€œç¼ºå£äººæ•°â€
            const targetId = map[areaId];
            const needText = document.getElementById(targetId)?.innerText || "0";
            const needCount = parseInt(needText) || 0; 
            
            const container = document.getElementById(areaId);
            if (container) {
                if (needCount > 0) {
                    for(let i=0; i<needCount; i++) {
                        const block = document.createElement('div');
                        block.className = 'gap-block';
                        block.innerText = `ç¼ºå£${i+1}`;
                        container.appendChild(block);
                    }
                } else {
                    container.innerHTML = '<div style="font-size:12px; color:#27ae60; padding:5px; font-weight:bold;">âœ¨ äººå‘˜å……è¶³ (å·²æ»¡è¶³éœ€æ±‚)</div>';
                }
            }
        }
    }

    function initSortable() {
        const containers = document.querySelectorAll('.pool-container, .sortable-zone');
        containers.forEach(el => {
            if(el._sortable) el._sortable.destroy();
            el._sortable = new Sortable(el, {
                group: 'staff',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    const itemEl = evt.item;
                    const fromKey = evt.from.id === 'pool-container' ? 'pool' : evt.from.id.replace('zone_', '');
                    const toKey = evt.to.id === 'pool-container' ? 'pool' : evt.to.id.replace('zone_', '');
                    if (fromKey === toKey && evt.newIndex === evt.oldIndex) return;
                    const movedItem = staffData[fromKey].splice(evt.oldIndex, 1)[0];
                    staffData[toKey].splice(evt.newIndex, 0, movedItem);
                    saveStaffData();
                }
            });
        });
    }

    /* === V15.3 PDFç”Ÿæˆ (å®½å±æˆªå›¾é€‚é… + å·¦å³å¸ƒå±€) === */
    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        const pdfContainer = document.getElementById('pdf-container');
        const msgEl = document.getElementById('pdf-msg');
        if(msgEl) msgEl.style.display = 'block';
        
        // --- 1. æˆªå›¾æ²™ç›˜ ---
        let schedulerImgData = null;
        let schedulerRatio = 0;
        
        const modal = document.getElementById('scheduler-modal');
        const schedulerContent = document.getElementById('scheduler-capture-area');
        
        const wasVisible = modal.style.display === 'flex';
        const originalStyle = schedulerContent.style.cssText;
        
        modal.style.display = 'flex';
        
        // å…‹éš†å¹¶åº”ç”¨å®½å±æ ·å¼
        schedulerContent.classList.add('pdf-mode-active'); 
        schedulerContent.style.width = '1350px'; 
        schedulerContent.style.height = 'auto'; 
        schedulerContent.style.position = 'fixed'; 
        schedulerContent.style.top = '-9999px';
        schedulerContent.style.left = '0';
        document.body.appendChild(schedulerContent); 

        // æ’å…¥æŠ¥è¡¨å¤´
        const headerDiv = document.createElement('div');
        headerDiv.innerHTML = `
            <div style="padding: 40px 40px 10px 40px; background: #fff; text-align: center;">
                <div style="font-size: 32px; font-weight: bold; color: #2C3E50; margin-bottom: 15px;">äººå‘˜æ’ç­è¯¦ç»†æ²™ç›˜</div>
                <div style="font-size: 16px; color: #7F8C8D; border-bottom: 2px solid #BDC3C7; padding-bottom: 20px; display: flex; justify-content: center; gap: 40px;">
                    <span>ğŸ“… æ‰§è¡Œæ—¥æœŸ: ${dateStr}</span>
                    <span>ğŸ­ æ‰€å±é¡¹ç›®: ${document.getElementById('project-select').selectedOptions[0].text}</span>
                </div>
            </div>
            <div style="padding: 10px 40px 30px 40px; background: #fff; color: #555; font-size: 14px; display: flex; justify-content: center; gap: 30px; align-items: center;">
                <strong style="font-size:16px;">å›¾ä¾‹ï¼š</strong> 
                <span style="display:flex; align-items:center;"><span style="width:16px; height:16px; background:#3498db; margin-right:6px; border-radius:3px;"></span> ç®¡ç†/æ–‡å‘˜</span>
                <span style="display:flex; align-items:center;"><span style="width:16px; height:16px; background:#27ae60; margin-right:6px; border-radius:3px;"></span> ä¸€çº¿å‘˜å·¥</span>
                <span style="display:flex; align-items:center;"><span style="width:16px; height:16px; background:#f1c40f; margin-right:6px; border-radius:3px;"></span> ä¸´æ—¶å·¥</span>
                <span style="display:flex; align-items:center; margin-left:10px;"><span style="width:16px; height:16px; background:#e74c3c; margin-right:6px; border-radius:3px;"></span> ç¼ºå£</span>
            </div>
        `;
        schedulerContent.insertBefore(headerDiv, schedulerContent.firstChild);

        try {
            await new Promise(r => setTimeout(r, 300)); 
            
            const canvas2 = await html2canvas(schedulerContent, { 
                scale: 1.5, 
                useCORS: true, 
                backgroundColor: '#ffffff',
                windowWidth: 1400,
                height: schedulerContent.scrollHeight
            });
            schedulerImgData = canvas2.toDataURL('image/png');
            schedulerRatio = canvas2.height / canvas2.width;
        } catch(e) { console.error("æˆªå›¾å¤±è´¥:", e); } 
        finally { 
            schedulerContent.classList.remove('pdf-mode-active'); 
            if(headerDiv.parentNode) headerDiv.parentNode.removeChild(headerDiv);
            document.getElementById('scheduler-modal').appendChild(schedulerContent); 
            schedulerContent.style.cssText = originalStyle; 
            schedulerContent.style.position = '';
            schedulerContent.style.top = '';
            schedulerContent.style.left = '';
            if(!wasVisible) modal.style.display = 'none'; 
        }

        // --- 2. æ„å»ºç¬¬ä¸€é¡µ ---
        const colorMap = {
            'roche': ['#2C3E50', '#c0392b', '#2980b9'], 
            'device': ['#556B2F', '#c0392b', '#9CAF88'], 
            'medicine': ['#555', '#c0392b', '#95A5A6']
        };
        const theme = colorMap[currentProject];
        const getTxt = (id) => document.getElementById(id)?.innerText || '0';
        const getVal = (id) => document.getElementById(id)?.value || '0';

        let html = `
            <div class="pdf-header">
                <div class="pdf-title" style="color:${theme[0]}">${getTxt('page-title')} - æ—¥æŠ¥</div>
                <div class="pdf-date">${dateStr}</div>
            </div>
            <div class="pdf-decision-row">
        `;
        if (currentProject === 'roche') {
            html += `<div class="pdf-kpi-card" style="background:var(--roche-blue)"><div class="pdf-kpi-title">â„ï¸ å†·é“¾éœ€æ±‚</div><div class="pdf-kpi-val">${getTxt('res_roche_cold')}</div><div class="pdf-kpi-sub">ç¼ºå£å·¥æ—¶: ${getTxt('gap_roche_cold')} H</div></div>`;
            html += `<div class="pdf-kpi-card" style="background:var(--roche-sand)"><div class="pdf-kpi-title">â˜€ï¸ å¸¸æ¸©éœ€æ±‚</div><div class="pdf-kpi-val">${getTxt('res_roche_amb')}</div><div class="pdf-kpi-sub">ç¼ºå£å·¥æ—¶: ${getTxt('gap_roche_amb')} H</div></div>`;
        } else if (currentProject === 'device') {
            html += `<div class="pdf-kpi-card" style="background:var(--device-green)"><div class="pdf-kpi-title">âš™ï¸ å™¨æ¢°éœ€æ±‚</div><div class="pdf-kpi-val">${getTxt('res_device')}</div><div class="pdf-kpi-sub">ç¼ºå£å·¥æ—¶: ${getTxt('gap_device')} H</div></div>`;
        } else {
            html += `<div class="pdf-kpi-card" style="background:var(--medicine-purple)"><div class="pdf-kpi-title">ğŸŒ¿ è¯å“éœ€æ±‚</div><div class="pdf-kpi-val">${getTxt('res_medicine')}</div><div class="pdf-kpi-sub">ç¼ºå£å·¥æ—¶: ${getTxt('gap_medicine')} H</div></div>`;
        }
        html += `<div class="pdf-kpi-card" style="background:#e74c3c"><div class="pdf-kpi-title">ğŸ† ä»Šæ—¥æ€»éœ€æ±‚</div><div class="pdf-kpi-val">${getTxt('res_total')}</div><div class="pdf-kpi-sub">ç­æ¬¡æ—¶é•¿: ${getTxt('res_shift')} H</div></div></div>`;

        let staffInfo = "";
        if(currentProject === 'roche') {
            staffInfo = `â„ï¸å†·é“¾(åœ¨${getVal('base_roche_cold')}/å®${getVal('fc_roche_cold')})  â˜€ï¸å¸¸æ¸©(åœ¨${getVal('base_roche_amb')}/å®${getVal('fc_roche_amb')})`;
        } else if (currentProject === 'device') {
            staffInfo = `âš™ï¸å™¨æ¢°(åœ¨${getVal('base_device')}/å®${getVal('fc_device')})`;
        } else {
            staffInfo = `ğŸŒ¿è¯å“(åœ¨${getVal('base_medicine')}/å®${getVal('fc_medicine')})`;
        }
        html += `<div class="pdf-resource-bar"><div class="pdf-res-item">åŸºç¡€å‚æ•°: <strong>Eff ${getVal('eff')} / OEE ${getVal('oee')}</strong></div><div class="pdf-res-item">æ­£å¼å·¥ç°çŠ¶: <strong>${staffInfo}</strong></div></div><div class="pdf-details-grid">`;

        const activeView = document.getElementById('view-' + currentProject);
        const cols = activeView.querySelectorAll('.col'); 
        cols.forEach(col => {
            html += `<div class="pdf-grid-col">`;
            const sectionTitle = col.querySelector('div[style*="font-weight:bold"]').innerText;
            html += `<div class="pdf-col-title">${sectionTitle}</div>`;
            col.querySelectorAll('.card').forEach(card => {
                const groupName = card.querySelector('h4').innerText;
                let groupHtml = `<div class="pdf-task-group"><div class="pdf-group-name">${groupName}</div>`;
                let hasItem = false;
                card.querySelectorAll('.data-input').forEach(input => {
                    if(parseInt(input.value) > 0) {
                        hasItem = true;
                        groupHtml += `<div class="pdf-task-item"><span class="pdf-task-name">${input.previousElementSibling.innerText}</span><span>${input.value}</span></div>`;
                    }
                });
                groupHtml += `</div>`;
                if(hasItem) html += groupHtml;
            });
            html += `</div>`;
        });
        html += `</div><div class="pdf-chart-section"><div class="pdf-chart-title">ğŸ“ˆ äººåŠ›åˆ†å¸ƒæ¨è (äºº)</div>${document.getElementById('chart-area').innerHTML}</div>`;
        pdfContainer.innerHTML = html;

        try {
            const canvas1 = await html2canvas(pdfContainer, { scale: 2 });
            const imgData1 = canvas1.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = 210;
            pdf.addImage(imgData1, 'PNG', 0, 0, pageWidth, canvas1.height * pageWidth / canvas1.width);

            if (schedulerImgData) {
                pdf.addPage();
                const contentWidth = 190;
                const contentHeight = schedulerRatio * contentWidth;
                pdf.addImage(schedulerImgData, 'PNG', 10, 10, contentWidth, contentHeight);
            }
            pdf.save(`${currentProject}_äººåŠ›æ—¥æŠ¥_${dateStr}.pdf`);
        } catch (e) {
            console.error(e);
            alert("PDF ç”Ÿæˆé‡åˆ°é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚");
        } finally {
            if(msgEl) msgEl.style.display = 'none';
            pdfContainer.innerHTML = ''; 
        }
    }

/* === V16.1 ç”Ÿæˆå¸¦æ’ç­æ•°æ®çš„é“¾æ¥ === */
    function generateLink() {
        const params = new URLSearchParams();
        
        // 1. ä¿å­˜ä¸šåŠ¡æ•°æ® (æ•°å­—)
        document.querySelectorAll('input, select').forEach(el => {
            if (el.value != 0 && el.id) params.set(el.id, el.value);
        });

        // 2. ä¿å­˜äººå‘˜æ’ç­æ•°æ® (JSON -> å‹ç¼©ç¼–ç )
        // æ³¨æ„ï¼šåªä¿å­˜æœ‰äººçš„æ•°æ®ï¼Œå‡å°é“¾æ¥é•¿åº¦
        try {
            const jsonStr = JSON.stringify(staffData);
            // ä½¿ç”¨ encodeURIComponent å¤„ç†ä¸­æ–‡ï¼Œbtoa è½¬ä¸º Base64
            const compressed = btoa(encodeURIComponent(jsonStr));
            params.set('sdata', compressed);
        } catch (e) {
            console.error("æ’ç­æ•°æ®ç¼–ç å¤±è´¥", e);
        }

        const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + "?" + params.toString();
        
        navigator.clipboard.writeText(newUrl).then(() => {
            document.getElementById('link-msg').style.display = 'block';
            setTimeout(() => { document.getElementById('link-msg').style.display = 'none'; }, 3000);
        }).catch(err => {
            alert("å¤åˆ¶å¤±è´¥ï¼Œå¯èƒ½æ˜¯é“¾æ¥å¤ªé•¿äº†");
        });
    }

    document.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('input', update);
    });

    window.onload = init;
</script>

</body>
</html>
