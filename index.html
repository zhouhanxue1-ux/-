<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©é©¬å›­åŒº | ç»¼åˆäººåŠ›æ’ç­å†³ç­–æ¨¡å‹</title>
    <meta name="robots" content="noindex, nofollow">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        :root {
            --bg-color: #FDFCFB;
            --text-main: #2C3E50;
            --text-sub: #7F8C8D;
            --border-color: #E0E0E0;
            
            /* è«å…°è¿ªé…è‰² */
            --roche-blue: #77929F;
            --roche-sand: #D4C4B7;
            --device-green: #9CAF88;
            --medicine-purple: #95A5A6; 
        }

        body {
            font-family: "Microsoft YaHei", "Heiti SC", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            gap: 20px;
            height: 100vh;
            overflow: hidden;
            box-sizing: border-box;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 340px;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            height: 100%;
            overflow-y: auto;
            flex-shrink: 0;
            scrollbar-width: thin;
        }
        .sidebar::-webkit-scrollbar { 
            width: 6px; 
        }
        .sidebar::-webkit-scrollbar-thumb { 
            background-color: #ccc; 
            border-radius: 3px; 
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
            overflow-y: auto;
            padding-right: 5px;
        }

        h1 { 
            font-size: 24px; 
            color: #5C6E7D; 
            margin: 0 0 5px 0; 
        }
        h3 { 
            font-size: 15px; 
            margin: 15px 0 10px 0; 
            color: var(--text-main); 
            font-weight: bold; 
        }
        h4 { 
            font-size: 15px; 
            margin: 0 0 10px 0; 
            font-weight: bold; 
        }

        label { 
            display: block; 
            margin-top: 10px; 
            font-size: 13px; 
            color: #555; 
            font-weight: 500; 
        }
        
        input[type="range"] { 
            width: 100%; 
            cursor: pointer; 
        }
        input[type="number"], select {
            width: 100%;
            padding: 6px 8px;
            margin-top: 4px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 13px;
        }
        
        /* åªè¯»è¾“å…¥æ¡†æ ·å¼ */
        .input-readonly { 
            background-color: #e9ecef; 
            color: #555; 
            font-weight: bold; 
            border: 1px solid #ced4da; 
            cursor: not-allowed; 
        }

        .staff-calc-group { 
            background-color: #f9f9f9; 
            padding: 12px; 
            border-radius: 6px; 
            border: 1px solid #eee; 
            margin-bottom: 15px; 
        }
        .staff-calc-group h5 { 
            margin: 0 0 8px 0; 
            font-size: 13px; 
            color: #333; 
            border-bottom: 1px dashed #ccc; 
            padding-bottom: 5px; 
        }
        .calc-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 6px; 
        }
        .calc-row label { 
            margin: 0; 
            font-size: 12px; 
            color: #666; 
        }
        .calc-row input { 
            width: 70px; 
            text-align: right; 
        }
        .calc-result-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-top: 8px; 
            padding-top: 8px; 
            border-top: 1px solid #e0e0e0; 
        }
        .calc-result-row label { 
            font-weight: bold; 
            color: #333; 
        }
        .calc-result-row input { 
            color: #2980b9; 
            width: 70px; 
            text-align: right; 
            font-weight: bold; 
        }

        #project-select { 
            padding: 10px; 
            font-size: 16px; 
            color: white; 
            background-color: var(--roche-blue); 
            border: none; 
            border-radius: 6px; 
            margin-bottom: 20px; 
            font-weight: bold; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        #project-select option { 
            background-color: white; 
            color: #333; 
        }

        .columns { 
            display: flex; 
            gap: 20px; 
            flex-wrap: wrap; 
        }
        .col { 
            flex: 1; 
            min-width: 320px; 
        }

        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            border: 1px solid var(--border-color); 
            margin-bottom: 20px; 
            transition: box-shadow 0.2s; 
        }
        .card:hover { 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
        }

        .view-roche .card-header-cold { 
            border-left: 5px solid var(--roche-blue); 
            padding-left: 10px; 
            margin-bottom: 15px; 
        }
        .view-roche .card-header-amb { 
            border-left: 5px solid var(--roche-sand); 
            padding-left: 10px; 
            margin-bottom: 15px; 
        }
        .view-device .card-header { 
            border-left: 5px solid var(--device-green); 
            padding-left: 10px; 
            margin-bottom: 15px; 
        }
        .view-medicine .card-header { 
            border-left: 5px solid var(--medicine-purple); 
            padding-left: 10px; 
            margin-bottom: 15px; 
        }

        .dashboard { 
            display: flex; 
            gap: 15px; 
            width: 100%; 
            flex-wrap: nowrap; 
            align-items: stretch; 
            flex-shrink: 0; 
        }
        #dash-roche-group { 
            display: flex; 
            gap: 15px; 
            flex: 2; 
        }
        #dash-device-group, #dash-medicine-group { 
            flex: 2; 
            display: flex; 
        }
        .dash-card { 
            flex: 1; 
            padding: 15px 5px; 
            background: white; 
            border-radius: 8px; 
            text-align: center; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.05); 
            min-width: 0; 
        }
        .dash-total { 
            flex: 1; 
            border-top: 5px solid #C6A4A4; 
            background: #FFF9F9; 
        }

        .metric-val { 
            font-size: 28px; 
            font-weight: bold; 
            margin: 5px 0; 
            white-space: nowrap; 
        }
        .metric-sub { 
            font-size: 12px; 
            color: var(--text-sub); 
        }

        .input-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
        }
        
        /* åº•éƒ¨å›¾è¡¨ */
        .chart-container { 
            background: white; 
            padding: 25px; 
            border-radius: 8px; 
            margin-top: 20px; 
            border: 1px solid var(--border-color); 
        }
        .chart-row { 
            display: flex; 
            align-items: center; 
            margin-bottom: 10px; 
            font-size: 13px; 
        }
        .chart-label { 
            width: 200px; 
            text-align: right; 
            padding-right: 15px; 
            color: #555; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            flex-shrink: 0; 
        }
        .chart-bar-area { 
            flex: 1; 
            background: #f0f0f0; 
            height: 24px; 
            border-radius: 4px; 
            overflow: hidden; 
        }
        .chart-bar { 
            height: 100%; 
            border-radius: 4px; 
            display: flex; 
            align-items: center; 
            padding-left: 10px; 
            color: white; 
            font-size: 12px; 
            white-space: nowrap;
        }
        .chart-val { 
            width: 120px; 
            padding-left: 10px; 
            font-weight: bold; 
            color: #333; 
            flex-shrink: 0; 
            text-align: left; 
        }

        .hidden { 
            display: none !important; 
        }
        
        .btn { 
            background-color: #5C6E7D; 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 5px; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 20px; 
            margin-bottom: 30px; 
            font-weight: bold; 
            font-size: 14px; 
            transition: all 0.2s; 
        }
        .btn:hover { 
            background-color: #4a5a6a; 
            transform: translateY(-1px); 
        }
        .btn-link { 
            margin-top: 10px; 
            font-size: 12px; 
            padding: 8px; 
            color: white; 
            border-radius: 4px; 
            cursor: pointer; 
            border: none; 
            font-weight: bold; 
        }
        
        /* æ¸…é™¤æŒ‰é’®æ ·å¼ */
        .btn-clear { 
            background-color: white; 
            color: #c0392b; 
            border: 1px solid #e74c3c; 
            margin-bottom: 10px; 
        }
        .btn-clear:hover { 
            background-color: #fcebe9; 
            transform: translateY(-1px); 
        }

        /* PDF éšè—åŸŸ */
        #pdf-container { 
            position: fixed; 
            left: -9999px; 
            top: 0; 
            width: 900px; 
            background: white; 
            padding: 40px; 
            box-sizing: border-box; 
            font-family: "Microsoft YaHei", sans-serif; 
            color: #333; 
        }
        .pdf-header { 
            border-bottom: 4px solid #5C6E7D; 
            padding-bottom: 10px; 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-end; 
        }
        .pdf-title { 
            font-size: 26px; 
            font-weight: bold; 
            color: #2C3E50; 
        }
        .pdf-date { 
            font-size: 14px; 
            color: #7F8C8D; 
        }
        .pdf-decision-row { 
            display: flex; 
            gap: 20px; 
            margin-bottom: 20px; 
        }
        .pdf-kpi-card { 
            flex: 1; 
            padding: 15px; 
            border-radius: 6px; 
            text-align: center; 
            color: white; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        .pdf-kpi-title { 
            font-size: 14px; 
            opacity: 0.9; 
            margin-bottom: 5px; 
        }
        .pdf-kpi-val { 
            font-size: 32px; 
            font-weight: bold; 
        }
        .pdf-kpi-sub { 
            font-size: 12px; 
            opacity: 0.8; 
            margin-top: 5px; 
        }
        .pdf-resource-bar { 
            background: #f4f6f7; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            padding: 10px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px; 
            font-size: 13px; 
        }
        .pdf-res-item strong { 
            color: #2C3E50; 
        }
        .pdf-details-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 30px; 
            margin-bottom: 20px; 
            align-items: start; 
        }
        .pdf-col-title { 
            font-size: 16px; 
            font-weight: bold; 
            color: #5C6E7D; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 8px; 
            margin-bottom: 10px; 
        }
        .pdf-task-group { 
            margin-bottom: 12px; 
            break-inside: avoid; 
        }
        .pdf-group-name { 
            font-size: 13px; 
            font-weight: bold; 
            color: #2C3E50; 
            margin-bottom: 4px; 
            background:#eef; 
            padding:2px 5px; 
            display:inline-block; 
            border-radius:3px; 
        }
        .pdf-task-item { 
            display: flex; 
            justify-content: space-between; 
            font-size: 12px; 
            color: #555; 
            border-bottom: 1px dashed #eee; 
            padding: 3px 0; 
        }
        .pdf-task-name { 
            font-weight: 500; 
        }
        .pdf-chart-section { 
            margin-top: 20px; 
            border-top: 2px solid #eee; 
            padding-top: 15px; 
        }
        .pdf-chart-title { 
            font-size: 14px; 
            font-weight: bold; 
            color: #7F8C8D; 
            margin-bottom: 10px; 
        }

        /* === æ’ç­æ²™ç›˜æ ·å¼ === */
        .scheduler-modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000; 
            justify-content: center; 
            align-items: center; 
        }
        .scheduler-content { 
            width: 95%; 
            height: 90%; 
            background: #fdfcfb; 
            border-radius: 12px; 
            display: flex; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            overflow: hidden; 
            border: 4px solid white; 
        }
        .res-pool-panel { 
            width: 280px; 
            background: #eaeded; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            border-right: 2px solid #ccc; 
            flex-shrink: 0; 
        }
        .pool-container { 
            flex: 1; 
            background: white; 
            border: 2px dashed #bdc3c7; 
            border-radius: 6px; 
            padding: 10px; 
            overflow-y: auto; 
            align-content: flex-start; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
        }
        .schedule-board { 
            flex: 1; 
            padding: 20px; 
            overflow-y: auto; 
            background: white; 
            display: flex; 
            gap: 20px; 
        }
        .schedule-col { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            height: 100%; 
        }
        
        .schedule-zone { 
            background: #f8f9fa;
            border: 2px dashed #dcdfe6; 
            border-radius: 8px; 
            padding: 10px; 
            display: flex; 
            flex-direction: column;
        }
        
        /* å†…éƒ¨æ”¾å°äººçš„ç›’å­ï¼šåŸºç¡€æ ·å¼ */
        .zone-box { 
            background: transparent;
            border: none !important; 
            display: flex;
            flex-wrap: wrap; 
            gap: 8px; 
            align-content: flex-start; 
            width: 100% !important;  
            padding-right: 5px;
        }
        
        /* æœ¬ç»„å‡ºå‹¤ (æ·¡ç´«è‰² + å¤§ç©ºé—´ + æ»šåŠ¨æ¡) */
        .zone-base-container .schedule-zone { 
            background: #f3e5f5;
            border-color: #ce93d8; 
            flex: 2; 
        }
        .zone-base-container .zone-box {
            min-height: 250px;
            max-height: 450px; 
            overflow-y: auto;
        }

        /* æ”¯æ´äººå‘˜ (æ·¡æ©™è‰² + è¾ƒå°ç©ºé—´) */
        .zone-sup-container .schedule-zone { 
            background: #fff3e0;
            border-color: #ffcc80; 
            flex: 1; 
        }
        .zone-sup-container .zone-box {
            min-height: 100px;
            max-height: 150px; 
            overflow-y: auto;
        }

        /* ç¼ºå£åŒºåŸŸ */
        .zone-gap-container .schedule-zone {
            background: #fff0f0;
            border-color: #fadbd8; 
            flex: 0 0 auto;
        }
        .zone-gap-container .zone-box {
            min-height: 60px;
        }

        .zone-title { 
            font-weight: bold; 
            margin-bottom: 8px; 
            font-size: 14px; 
            display: flex; 
            justify-content: space-between; 
            color: #555; 
        }
        .zone-box::-webkit-scrollbar { 
            width: 6px; 
        }
        .zone-box::-webkit-scrollbar-thumb { 
            background-color: #ccc; 
            border-radius: 3px; 
        }
        
        /* äººå‘˜å¡ç‰‡ */
        .staff-card { 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 12px; 
            font-weight: bold; 
            color: white; 
            cursor: grab; 
            display: inline-flex; 
            align-items: center; 
            gap: 5px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            user-select: none; 
            position: relative; 
            height: 24px; 
        }
        .staff-card:active { 
            cursor: grabbing; 
            transform: scale(1.05); 
        }
        .staff-type-1 { background: #3498db; }
        .staff-type-2 { background: #9b59b6; }
        .staff-type-3 { background: #27ae60; }
        .staff-type-4 { background: #f1c40f; color: #333; }
        
        .staff-delete { 
            display: none; 
            width: 16px; 
            height: 16px; 
            background: rgba(0,0,0,0.2); 
            border-radius: 50%; 
            text-align: center; 
            line-height: 14px; 
            font-size: 10px; 
            cursor: pointer; 
            margin-left: 5px; 
        }
        .staff-card:hover .staff-delete { 
            display: inline-block; 
        }
        
        .gap-block { 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 12px; 
            font-weight: bold; 
            color: white; 
            background: #e74c3c; 
            opacity: 0.8; 
            border: 1px dashed white; 
            cursor: not-allowed; 
        }
        
        .add-staff-area { 
            margin-bottom: 15px; 
            padding-bottom: 15px; 
            border-bottom: 1px solid #ccc; 
        }
        .add-staff-area textarea { 
            width: 100%; 
            height: 60px; 
            margin-bottom: 5px; 
            font-size: 12px; 
            padding: 5px; 
            border-radius: 4px; 
            border:1px solid #ccc; 
        }
        .type-radio { 
            font-size: 12px; 
            margin-right: 8px; 
            cursor: pointer; 
        }

        /* === ç»ˆæ PDF æŠ¥è¡¨æ ·å¼ (å®½å±æˆªå›¾é€‚é…) === */
        .pdf-mode-active {
            display: block !important;
            background: white !important;
            box-shadow: none !important;
            border: none !important;
            padding: 0 !important;
            position: absolute !important;
            top: 0;
            left: 0;
            z-index: -9999;
            min-width: 1280px !important; 
        }
        
        /* éšè—æ‚é¡¹ */
        .pdf-mode-active .res-pool-panel,
        .pdf-mode-active .add-staff-area,
        .pdf-mode-active .staff-delete,
        .pdf-mode-active .scheduler-content > button { 
            display: none !important;
        }

        /* ä¸»ä½“å®¹å™¨ï¼šå·¦å³å¸ƒå±€ï¼Œæ’‘æ»¡ */
        .pdf-mode-active .schedule-board {
            width: 100% !important;
            padding: 20px 80px 20px 0px !important;
            margin: 0 !important;
            background: white !important;
            display: flex !important;
            gap: 30px !important;
            align-items: flex-start !important;
        }

        .pdf-mode-active #sched-view-roche {
            display: flex !important;
            flex-direction: row !important; 
            width: 100% !important;
            gap: 30px !important;
        }

        .pdf-mode-active .schedule-col {
            flex: 1 !important;
            border: none !important;
            padding: 0 !important;
            height: auto !important;
            width: auto !important;
        }

        /* ç›’å­å…¨å±•å¼€ */
        .pdf-mode-active .schedule-zone,
        .pdf-mode-active .zone-box {
            max-height: none !important;
            min-height: 80px !important;
            overflow: visible !important;
            height: auto !important;
            display: flex !important;
            flex-wrap: wrap !important;
            background: #fff !important;
            border: 1px solid #ddd !important;
            margin-bottom: 15px;
        }

        .pdf-mode-active .zone-gap-container {
            display: block !important;
            height: auto !important;
        }

        .pdf-mode-active h3 {
            color: #2c3e50 !important;
            border-bottom: 2px solid #7f8c8d;
            padding-bottom: 10px;
            margin-top: 0 !important;
            margin-bottom: 20px;
            font-size: 20px !important;
            text-align: center;
        }

        @media print {
            body { 
                height: auto; 
                overflow: visible; 
                display: block; 
            }
            .sidebar, .btn { 
                display: none; 
            }
            .chart-container { 
                break-inside: avoid; 
            }
            .main-content { 
                height: auto; 
                overflow: visible; 
            }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <label style="margin-top:0">ğŸ“Š é€‰æ‹©é¡¹ç›®ç»„</label>
        <select id="project-select" onchange="switchView()">
            <option value="roche_cold">â„ï¸ ç½—è¯Šå†·åº“</option>
            <option value="roche_amb">â˜€ï¸ ç½—è¯Šå¸¸æ¸©</option>
            <option value="device">âš™ï¸ å™¨æ¢°</option>
            <option value="medicine">ğŸŒ¿ è¯å“</option>
        </select>

        <h2>âš™ï¸ å†³ç­–å‚æ•°</h2>
 
        <label>æ•ˆç‡ç³»æ•° <span id="disp_eff" style="float:right; font-weight:bold;">1.00</span></label>
        <input type="range" id="eff" min="0.1" max="1.0" step="0.05" value="1.0" oninput="update()">
        <label>æœ‰æ•ˆä½œä¸šç‡ <span id="disp_oee" style="float:right; font-weight:bold;">1.00</span></label>
        <input type="range" id="oee" min="0.1" max="1.0" step="0.05" value="1.0" oninput="update()">
        
        <div style="margin-bottom:15px; margin-top:15px;">
            <label>â±ï¸ ç­æ¬¡æ—¶é•¿</label>
            <div id="shift_roche_cold_div" style="display:none; justify-content:space-between; margin-bottom:5px;">
                <span style="font-size:12px; color:#666; line-height:28px;">â„ï¸å†·åº“:</span>
                <input type="number" id="shift_roche_cold" value="8" min="1" max="24" step="0.5" oninput="update()" style="width:60px; text-align:right;">
            </div>
            <div id="shift_roche_amb_div" style="display:none; justify-content:space-between; margin-bottom:5px;">
                <span style="font-size:12px; color:#666; line-height:28px;">â˜€ï¸å¸¸æ¸©:</span>
                <input type="number" id="shift_roche_amb" value="8" min="1" max="24" step="0.5" oninput="update()" style="width:60px; text-align:right;">
            </div>
            <div id="shift_device_div" style="display:none; justify-content:space-between; margin-bottom:5px;">
                <span style="font-size:12px; color:#666; line-height:28px;">âš™ï¸å™¨æ¢°:</span>
                <input type="number" id="shift_device" value="8" min="1" max="24" step="0.5" oninput="update()" style="width:60px; text-align:right;">
            </div>
            <div id="shift_medicine_div" style="display:none; justify-content:space-between; margin-bottom:5px;">
                <span style="font-size:12px; color:#666; line-height:28px;">ğŸŒ¿è¯å“:</span>
                <input type="number" id="shift_medicine" value="8" min="1" max="24" step="0.5" oninput="update()" style="width:60px; text-align:right;">
            </div>
        </div>

        <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee;">
            <h3>ğŸ‘¥ æ­£å¼å·¥å‡ºå‹¤è®¡ç®—</h3>
            <button class="btn" onclick="openScheduler()" style="margin: 5px 0 15px 0; background: #8e44ad; padding: 8px; font-size: 13px;">ğŸ§© æ‰“å¼€äººå‘˜æ’ç­æ²™ç›˜ (ç‚¹å)</button>
            
            <div id="formal-roche">
                <div id="formal-roche-cold-group" class="staff-calc-group">
                    <h5>â„ï¸ ç½—è¯Šå†·åº“ç»„</h5>
                    <div class="calc-row">
                        <label>ğŸ  æœ¬ç»„å‡ºå‹¤</label>
                        <input type="number" id="base_roche_cold" class="staff-base input-readonly" readonly style="pointer-events: none; background-color: #e9ecef;" min="0" value="0">
                    </div>
                    <div class="calc-row">
                        <label>ğŸŸ§ æ´¾æ¥æ”¯æ´</label>
                        <input type="number" id="sup_roche_cold" class="staff-dynamic input-readonly" readonly style="pointer-events: none; background-color: #e9ecef;" min="0" value="0">
                    </div>
                    <div class="calc-result-row"><label>ã€“ å®é™…å¯ç”¨</label><input type="number" id="fc_roche_cold" class="input-readonly" readonly value="0"></div>
                </div>
                <div id="formal-roche-amb-group" class="staff-calc-group">
                    <h5>â˜€ï¸ ç½—è¯Šå¸¸æ¸©ç»„</h5>
                    <div class="calc-row">
                        <label>ğŸ  æœ¬ç»„å‡ºå‹¤</label>
                        <input type="number" id="base_roche_amb" class="staff-base input-readonly" readonly style="pointer-events: none; background-color: #e9ecef;" min="0" value="0">
                    </div>
                    <div class="calc-row">
                        <label>ğŸŸ§ æ´¾æ¥æ”¯æ´</label>
                        <input type="number" id="sup_roche_amb" class="staff-dynamic input-readonly" readonly style="pointer-events: none; background-color: #e9ecef;" min="0" value="0">
                    </div>
                    <div class="calc-result-row"><label>ã€“ å®é™…å¯ç”¨</label><input type="number" id="fc_roche_amb" class="input-readonly" readonly value="0"></div>
                </div>
            </div>
            
            <div id="formal-device" class="hidden">
                <div class="staff-calc-group">
                    <h5>âš™ï¸ å™¨æ¢°ç»„</h5>
                    <div class="calc-row">
                        <label>ğŸ  æœ¬ç»„å‡ºå‹¤</label>
                        <input type="number" id="base_device" class="staff-base input-readonly" readonly style="pointer-events: none; background-color: #e9ecef;" min="0" value="0">
                    </div>
                    <div class="calc-row">
                        <label>ğŸŸ§ æ´¾æ¥æ”¯æ´</label>
                        <input type="number" id="sup_device" class="staff-dynamic input-readonly" readonly style="pointer-events: none; background-color: #e9ecef;" min="0" value="0">
                    </div>
                    <div class="calc-result-row"><label>ã€“ å®é™…å¯ç”¨</label><input type="number" id="fc_device" class="input-readonly" readonly value="0"></div>
                </div>
            </div>

            <div id="formal-medicine" class="hidden">
                <div class="staff-calc-group">
                    <h5>ğŸŒ¿ è¯å“ç»„</h5>
                    <div class="calc-row">
                        <label>ğŸ  æœ¬ç»„å‡ºå‹¤</label>
                        <input type="number" id="base_medicine" class="staff-base input-readonly" readonly style="pointer-events: none; background-color: #e9ecef;" min="0" value="0">
                    </div>
                    <div class="calc-row">
                        <label>ğŸŸ§ æ´¾æ¥æ”¯æ´</label>
                        <input type="number" id="sup_medicine" class="staff-dynamic input-readonly" readonly style="pointer-events: none; background-color: #e9ecef;" min="0" value="0">
                    </div>
                    <div class="calc-result-row"><label>ã€“ å®é™…å¯ç”¨</label><input type="number" id="fc_medicine" class="input-readonly" readonly value="0"></div>
                </div>
            </div>
        </div>

        <div style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
            
            <div style="display:flex; gap:10px; margin-bottom: 10px;">
                <button class="btn btn-clear" style="flex:1; margin-bottom:0; font-size:12px; padding: 10px 5px;" onclick="clearData(false)">ğŸ—‘ï¸ æ¸…ç©º[å½“å‰ç»„]ä¸šåŠ¡é‡</button>
                <button class="btn btn-clear" style="flex:1; margin-bottom:0; font-size:12px; padding: 10px 5px;" onclick="clearData(true)">ğŸ—‘ï¸ æ¸…ç©º[æ‰€æœ‰]ä¸šåŠ¡é‡</button>
            </div>

            <button class="btn" onclick="generatePDF()" style="background-color: #e74c3c; margin-bottom: 10px;">ğŸ“„ ç”Ÿæˆå¸¸è§„æ±‡æŠ¥ PDF</button>
            
            <button class="btn" id="btn-combined-pdf" onclick="generateCombinedPDF()" style="background-color: #8e44ad; margin-top: 0px; margin-bottom: 10px; display: none;">ğŸ“„ ç”Ÿæˆå¸¸æ¸©+å†·åº“è”åˆç‰ˆ PDF</button>

            <div id="pdf-msg" style="font-size:12px; color:#c0392b; text-align:center; display:none;">ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...</div>
            
            <div style="display:flex; gap:10px;">
                <button class="btn btn-link" style="flex:1; margin-top:10px; background-color:#27ae60;" onclick="generateLink(false)">ğŸ”— ç”Ÿæˆ[å½“å‰ç»„]çº¯å‡€é“¾æ¥</button>
                <button class="btn btn-link" style="flex:1; margin-top:10px; background-color:#95a5a6;" onclick="generateLink(true)">ğŸ”— ç”Ÿæˆ[å…¨é‡]è”åˆé“¾æ¥</button>
            </div>
            
            <div id="link-msg" style="font-size:12px; color:#27ae60; text-align:center; display:none; margin-top:5px;">é“¾æ¥å·²å¤åˆ¶</div>
        </div>
    </div>

    <div class="main-content">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom: 2px solid #eee; padding-bottom: 10px;">
            <div>
                <h1 id="page-title">ç½—è¯Šå†·åº“é¡¹ç›®äººåŠ›æ’ç­å†³ç­–æ¨¡å‹</h1>
            </div>
            <div style="text-align:right;">
                <h3 id="currentDate" style="color:#5C6E7D; margin:0;"></h3>
            </div>
        </div>

        <div class="dashboard">
            <div id="dash-roche-group">
                <div id="dash-roche-cold-card" class="dash-card" style="border-top: 5px solid var(--roche-blue); background: #F4F7F9;">
                    <h4 style="color:#2C3E50">â„ï¸ å†·åº“éœ€æ±‚</h4>
                    <div class="metric-val" id="res_roche_cold">0 äºº</div>
                    <div class="metric-sub">ç¼ºå£: <span id="gap_roche_cold">0.0</span> å°æ—¶</div>
                </div>
              
                <div id="dash-roche-amb-card" class="dash-card" style="border-top: 5px solid var(--roche-sand); background: #F9F7F5; margin-left: 15px;">
                    <h4 style="color:#5D5046">â˜€ï¸ å¸¸æ¸©éœ€æ±‚</h4>
                    <div class="metric-val" id="res_roche_amb">0 äºº</div>
                    <div class="metric-sub">ç¼ºå£: <span id="gap_roche_amb">0.0</span> å°æ—¶</div>
                </div>
            </div>
  
            <div id="dash-device-group" class="hidden">
                <div class="dash-card" style="border-top: 5px solid var(--device-green); background: var(--device-bg); width: 100%;">
                    <h4 style="color:#556B2F">âš™ï¸ å™¨æ¢°ç»„éœ€æ±‚</h4>
                    <div class="metric-val" id="res_device">0 äºº</div>
                    <div class="metric-sub">ç¼ºå£: <span id="gap_device">0.0</span> å°æ—¶</div>
                </div>
            </div>

            <div id="dash-medicine-group" class="hidden">
                <div class="dash-card" style="border-top: 5px solid var(--medicine-purple); background: var(--medicine-bg); width: 100%;">
                    <h4 style="color:#555">ğŸŒ¿ è¯å“ç»„éœ€æ±‚</h4>
                    <div class="metric-val" id="res_medicine">0 äºº</div>
                    <div class="metric-sub">ç¼ºå£: <span id="gap_medicine">0.0</span> å°æ—¶</div>
                </div>
            </div>

            <div class="dash-card dash-total">
                <h4 style="color:#922B21">ğŸ† ä»Šæ—¥æ€»éœ€æ±‚</h4>
                <div class="metric-val" style="color:#922B21" id="res_total">0 äºº</div>
                <div class="metric-sub">ç­æ¬¡: <span id="res_shift">8</span> å°æ—¶</div>
            </div>
        </div>

        
        <div id="view-roche" class="columns view-roche">
            <div id="view-roche-cold-col" class="col">
                <div style="background:var(--roche-blue); color:white; padding:10px; border-radius:6px; margin-bottom:15px; font-weight:bold;">â„ï¸ ç½—è¯Šå†·åº“ç»„</div>
                <div class="card">
                    <div class="card-header-cold"><h4>ğŸ“¦ ç½—è¯Šå†·åº“ (ä¸»è¥)</h4></div>
                    <div class="input-grid">
                        <div class="input-item">
                            <label>æ”¶è´§ç¿»æ‰˜/å…¨æ£€ (æ‰˜)</label>
                            <input type="number" class="data-input" data-uph="2.5" id="c_ft">
                        </div>
                        <div class="input-item">
                            <label>æ”¶è´§ä¸Šæ¶ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="20" id="c_sj">
                        </div>
                        <div class="input-item">
                            <label>å‘è´§æ‹£è´§ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="20" id="c_jh">
                        </div>
                        <div class="input-item">
                            <label>æ‰«æåŒ…è£… (ç›’)</label>
                            <input type="number" class="data-input" data-uph="110" id="c_bz">
                        </div>
                        <div class="input-item">
                            <label>æ‹†å°è“ç®± (ä¸ª)</label>
                            <input type="number" class="data-input" data-uph="13" id="c_lx">
                        </div>
                        <div class="input-item">
                            <label>æ¸©åº¦è®¡ä¸‹è½½ (ä¸ª)</label>
                            <input type="number" class="data-input" data-uph="30" id="c_lxx">
                        </div>
                    </div>
                </div>
  
                <div class="card">
                    <div class="card-header-cold"><h4>ğŸ§Š å®‰æ·ä¼¦(å†·åº“)</h4></div>
                    <div class="input-grid">
                        <div class="input-item">
                            <label>æ”¶è´§ä¸Šæ¶ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="20" id="ag_sj">
                        </div>
                        <div class="input-item">
                            <label>å‘è´§æ‹£è´§ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="20" id="ag_jh">
                        </div>
                        <div class="input-item">
                            <label>æ‰«æåŒ…è£… (ç›’)</label>
                            <input type="number" class="data-input" data-uph="75" id="ag_bz">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header-cold"><h4>ğŸ§Š è±ªæ´›æ·(å†·åº“)</h4></div>
                    <div class="input-grid">
                        <div class="input-item">
                            <label>æ”¶è´§ä¸Šæ¶ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="20" id="ho_sj">
                        </div>
                        <div class="input-item">
                            <label>å‘è´§æ‹£è´§ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="20" id="ho_jh">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header-cold"><h4>ğŸ§Š ç½—è¯Šè‡ªè¥</h4></div>
                    <div class="input-grid">
                        <div class="input-item">
                            <label>æ”¶è´§ä¸Šæ¶ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="20" id="se_sj">
                        </div>
                        <div class="input-item">
                            <label>å‘è´§æ‹£è´§ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="20" id="se_jh">
                        </div>
                        <div class="input-item">
                            <label>æ‰«æåŒ…è£… (ç›’)</label>
                            <input type="number" class="data-input" data-uph="75" id="se_bz">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header-cold"><h4>ğŸ” åŠ¨æ€ç›˜ç‚¹</h4></div>
                    <div class="input-grid">
                        <div class="input-item">
                            <label>å†·åº“ç›˜ç‚¹ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="20" id="c_pd">
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="view-roche-amb-col" class="col">
                <div style="background:var(--roche-sand); color:#5D5046; padding:10px; border-radius:6px; margin-bottom:15px; font-weight:bold;">â˜€ï¸ ç½—è¯Šå¸¸æ¸©ç»„</div>
                <div class="card">
                    <div class="card-header-amb"><h4>ğŸ§ª ç½—æ°è¯•å‰‚</h4></div>
                    <div class="input-grid">
                        <div class="input-item">
                            <label>ä¸Šæ¶ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="13" data-subtype="amb" id="r_sj">
                        </div>
                        <div class="input-item">
                            <label>å–è´§ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="13" data-subtype="amb" id="r_qh">
                        </div>
                        <div class="input-item">
                            <label>æ‰«æåŒ…è£… (ç›’)</label>
                            <input type="number" class="data-input" data-uph="120" data-subtype="amb" id="r_bz">
                        </div>
                        <div class="input-item">
                            <label>è½¬å‚¨ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="13" data-subtype="amb" id="r_zc">
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header-amb"><h4>ğŸ”¬ ç½—æ°ä»ªå™¨</h4></div>
                    <div class="input-grid">
                        <div class="input-item">
                            <label>å›½å†…åˆ°è´§æ¸…ç‚¹ (ç›’)</label>
                            <input type="number" class="data-input" data-uph="80" data-subtype="amb" id="i_qd">
                        </div>
                        <div class="input-item">
                            <label>ä¸Šæ¶ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="13" data-subtype="amb" id="i_sj">
                        </div>
                        <div class="input-item">
                            <label>å–è´§ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="10" data-subtype="amb" id="i_qh">
                        </div>
                        <div class="input-item">
                            <label>æ‰«æåŒ…è£… (ä»¶)</label>
                            <input type="number" class="data-input" data-uph="50" data-subtype="amb" id="i_bz">
                        </div>
                        <div class="input-item">
                            <label>è½¬å‚¨ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="13" data-subtype="amb" id="i_zc">
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header-amb"><h4>ğŸ“¦ ç½—è¯Š2æ–¹</h4></div>
                    <div class="input-grid">
                        <div class="input-item">
                            <label>åˆ°è´§æ¸…ç‚¹ (ä»¶)</label>
                            <input type="number" class="data-input" data-uph="200" data-subtype="amb" id="p2_qd">
                        </div>
                        <div class="input-item">
                            <label>ä¸Šæ¶ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="13" data-subtype="amb" id="p2_sj">
                        </div>
                        <div class="input-item">
                            <label>ä¸‹æ¶ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="13" data-subtype="amb" id="p2_xj">
                        </div>
                        <div class="input-item">
                            <label>åŒ…è£… (ä»¶)</label>
                            <input type="number" class="data-input" data-uph="100" data-subtype="amb" id="p2_bz">
                        </div>
                        <div class="input-item">
                            <label>è½¬å‚¨ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="13" data-subtype="amb" id="p2_zc">
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header-amb"><h4>ğŸ¦· å£«å“æ›¼</h4></div>
                    <div class="input-grid">
                        <div class="input-item">
                            <label>åˆ°è´§æ¸…ç‚¹ (ä»¶)</label>
                            <input type="number" class="data-input" data-uph="200" data-subtype="amb" id="st_qd">
                        </div>
                        <div class="input-item">
                            <label>ä¸Šæ¶ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="13" data-subtype="amb" id="st_sj">
                        </div>
                        <div class="input-item">
                            <label>ä¸‹æ¶ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="13" data-subtype="amb" id="st_xj">
                        </div>
                        <div class="input-item">
                            <label>åŒ…è£… (ä»¶)</label>
                            <input type="number" class="data-input" data-uph="200" data-subtype="amb" id="st_bz">
                        </div>
                        <div class="input-item">
                            <label>è½¬å‚¨ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="13" data-subtype="amb" id="st_zc">
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header-amb"><h4>ğŸ˜· é˜²ç–«ç‰©èµ„</h4></div>
                    <div class="input-grid">
                        <div class="input-item">
                            <label>åˆ°è´§æ¸…ç‚¹ (ä»¶)</label>
                            <input type="number" class="data-input" data-uph="200" data-subtype="amb" id="fy_qd">
                        </div>
                        <div class="input-item">
                            <label>ä¸Šæ¶ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="13" data-subtype="amb" id="fy_sj">
                        </div>
                        <div class="input-item">
                            <label>ä¸‹æ¶ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="13" data-subtype="amb" id="fy_xj">
                        </div>
                        <div class="input-item">
                            <label>åŒ…è£… (ä»¶)</label>
                            <input type="number" class="data-input" data-uph="400" data-subtype="amb" id="fy_bz">
                        </div>
                        <div class="input-item">
                            <label>è½¬å‚¨ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="13" data-subtype="amb" id="fy_zc">
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header-amb"><h4>ğŸ¥ è¿ˆç‘</h4></div>
                    <div class="input-grid">
                        <div class="input-item">
                            <label>åˆ°è´§æ¸…ç‚¹ (ä»¶)</label>
                            <input type="number" class="data-input" data-uph="100" data-subtype="amb" id="mr_qd">
                        </div>
                        <div class="input-item">
                            <label>ä¸Šæ¶ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="13" data-subtype="amb" id="mr_sj">
                        </div>
                        <div class="input-item">
                            <label>ä¸‹æ¶ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="13" data-subtype="amb" id="mr_xj">
                        </div>
                        <div class="input-item">
                            <label>åŒ…è£… (ä»¶)</label>
                            <input type="number" class="data-input" data-uph="100" data-subtype="amb" id="mr_bz">
                        </div>
                        <div class="input-item">
                            <label>è½¬å‚¨ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="13" data-subtype="amb" id="mr_zc">
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header-amb"><h4>ğŸ”„ å…¶ä»–</h4></div>
                    <div class="input-grid">
                        <div class="input-item">
                            <label>å¸¸æ¸©é€€è´§ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="2" data-subtype="amb" id="oth_th">
                        </div>
                        <div class="input-item">
                            <label>å¸¸æ¸©ç›˜ç‚¹ (æ¡)</label>
                            <input type="number" class="data-input" data-uph="13" data-subtype="amb" id="oth_pd">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-device" class="columns view-device hidden">
            <div class="col">
                <div style="background:var(--device-green); color:white; padding:10px; border-radius:6px; margin-bottom:15px; font-weight:bold;">âš™ï¸ å™¨æ¢°é¡¹ç›®ç»„</div>
                <div class="card">
                    <div class="card-header"><h4>ğŸ”© ä¸“é¡¹æ“ä½œ (ä¸“é¡¹/å¢¨å°¼å…‹/é”é€‚)</h4></div>
                    <div class="input-grid">
                        <div class="input-item">
                            <label>ä¸“é¡¹åˆ°è´§æ¸…ç‚¹ (ä»¶)</label>
                            <input type="number" class="data-input device-input" data-uph="200" id="d_sp_qd">
                        </div>
                        <div class="input-item">
                            <label>å¢¨å°¼å…‹ç¿»æ‰˜ (æ‰˜)</label>
                            <input type="number" class="data-input device-input" data-uph="20" id="d_mnk_ft">
                        </div>
                        <div class="input-item">
                            <label>å¢¨å°¼å…‹åŒ…è£… (ç›’)</label>
                            <input type="number" class="data-input device-input" data-uph="50" id="d_mnk_bz">
                        </div>
                        <div class="input-item">
                            <label>é”é€‚ç»„åˆä»¶ (ç›’)</label>
                            <input type="number" class="data-input device-input" data-uph="50" id="d_rs_bom">
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h4>ğŸ› ï¸ å™¨æ¢°é€šç”¨æ“ä½œ</h4></div>
                    <div class="input-grid">
                        <div class="input-item">
                            <label>æ”¶è´§ä¸Šæ¶ (æ¡)</label>
                            <input type="number" class="data-input device-input" data-uph="15" id="d_sj">
                        </div>
                        <div class="input-item">
                            <label>å‘è´§ä¸‹æ¶ (æ¡)</label>
                            <input type="number" class="data-input device-input" data-uph="15" id="d_xj">
                        </div>
                        <div class="input-item">
                            <label>æ‰«æåŒ…è£… (ç›’)</label>
                            <input type="number" class="data-input device-input" data-uph="50" id="d_bz">
                        </div>
                        <div class="input-item">
                            <label>è´´æ ‡ (ç›’)</label>
                            <input type="number" class="data-input device-input" data-uph="100" id="d_tb">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-medicine" class="columns view-medicine hidden">
            <div class="col">
                <div style="background:var(--medicine-purple); color:white; padding:10px; border-radius:6px; margin-bottom:15px; font-weight:bold;">ğŸŒ¿ è¯å“é¡¹ç›®ç»„</div>
                <div class="card">
                    <div class="card-header"><h4>ğŸ’Š è¯å“åŸºç¡€ä½œä¸š</h4></div>
                    <div class="input-grid">
                        <div class="input-item">
                            <label>æ”¶è´§ä¸Šæ¶ (æ¡)</label>
                            <input type="number" class="data-input medicine-input" data-uph="12" id="p_sj">
                        </div>
                        <div class="input-item">
                            <label>å‘è´§ä¸‹æ¶ (æ¡)</label>
                            <input type="number" class="data-input medicine-input" data-uph="12" id="p_xj">
                        </div>
                        <div class="input-item">
                            <label>æ‰«æåŒ…è£… (æ¡)</label>
                            <input type="number" class="data-input medicine-input" data-uph="7" id="p_bz">
                        </div>
                        <div class="input-item">
                            <label>è´´æ ‡ (ç›’)</label>
                            <input type="number" class="data-input medicine-input" data-uph="200" id="p_tb">
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h4>ğŸ—ï¸ è¯å“ä¸“é¡¹ä½œä¸š</h4></div>
                    <div class="input-grid">
                        <div class="input-item">
                            <label>ç½—è´¸&ç½—è¯ç¿»æ‰˜ (æ‰˜)</label>
                            <input type="number" class="data-input medicine-input" data-uph="1" id="p_ft">
                        </div>
                        <div class="input-item">
                            <label>è±ªæ´›æ·æ”¶è´§ (æ¡)</label>
                            <input type="number" class="data-input medicine-input" data-uph="10" id="p_hlj_sh">
                        </div>
                        <div class="input-item">
                            <label>è±ªæ´›æ·æ‰“æ ‡ç­¾ (ä¸ª)</label>
                            <input type="number" class="data-input medicine-input" data-uph="3500" id="p_hlj_tb">
                        </div>
                        <div class="input-item">
                            <label>ç”µå•†åˆ†åŒ… (å¥—)</label>
                            <input type="number" class="data-input medicine-input" data-uph="45" id="p_ds">
                        </div>
                    </div>
                </div>
             </div>
        </div>

        <div class="chart-container">
            <h3 style="margin-bottom:20px;">ğŸ“Š å„ç¯èŠ‚äººåŠ›åˆ†å¸ƒæ¨è</h3>
            <div id="chart-area">
                <div style="text-align:center; color:#999; padding:20px;">æš‚æ— è¾“å…¥æ•°æ®</div>
            </div>
        </div>
    </div>

    <div id="pdf-container"></div>
    
    <div id="scheduler-modal" class="scheduler-modal">
        <div class="scheduler-content" id="scheduler-capture-area">
            <div class="res-pool-panel">
                <h4 style="margin-top:0">ğŸ—‚ï¸ ä¸“å±èµ„æºæ± </h4>
                <div class="add-staff-area">
                    <textarea id="new-staff-names" placeholder="æ‰¹é‡æ·»åŠ å§“å (ç©ºæ ¼éš”å¼€)"></textarea>
                    
                    <div style="margin-bottom:8px; display:flex; gap:10px; align-items:center;">
                        <select id="staff-origin" style="padding:4px; border-radius:4px; border:1px solid #ccc; font-size:12px; width:80px; margin:0;">
                            <option value="å†·åº“">å†·åº“</option>
                            <option value="å¸¸æ¸©">å¸¸æ¸©</option>
                            <option value="å™¨æ¢°">å™¨æ¢°</option>
                            <option value="è¯å“">è¯å“</option>
                        </select>
                        <span style="font-size:12px; color:#7F8C8D;">æ”¯æ´å¤–ç»„å°†é™„å¸¦æ­¤æ¥æºå‰ç¼€</span>
                    </div>

                    <div style="margin-bottom:5px;">
                        <label class="type-radio"><input type="radio" name="staffType" value="3" checked>ğŸŸ©ä¸€çº¿</label>
                        <label class="type-radio"><input type="radio" name="staffType" value="4">ğŸŸ¨ä¸´æ—¶</label>
                        <label class="type-radio"><input type="radio" name="staffType" value="1">ğŸŸ¦ç®¡ç†</label>
                        <label class="type-radio"><input type="radio" name="staffType" value="2">ğŸŸªæ–‡å‘˜</label>
                    </div>
                    
                    <button class="btn" onclick="addNewStaff()" style="margin:0; padding:6px; background:#2c3e50;">â• æ‰¹é‡å…¥æ± </button>
                    
                    <div style="display:flex; gap:5px; margin-top: 10px;">
                        <button onclick="returnAllToPool()" style="flex:1; padding:6px; font-size:12px; background:#f39c12; color:white; border:none; border-radius:4px; cursor:pointer;">â†©ï¸ ä¸€é”®å›æ± </button>
                        <button onclick="clearResourcePool()" style="flex:1; padding:6px; font-size:12px; background:#c0392b; color:white; border:none; border-radius:4px; cursor:pointer;">ğŸ§¹ æ¸…ç©ºèµ„æºæ± </button>
                    </div>
                </div>
                
                <div style="font-size:12px; color:#666; margin-bottom:5px;">æ‹–æ‹½äººå‘˜åˆ°å³ä¾§æ’ç­ (ç‚¹å‡»Xå›æ± )</div>
                <div id="pool-container" class="pool-container"></div>
            </div>

            <div class="schedule-board">
                <div id="sched-view-roche" class="schedule-col hidden" style="display:flex; flex-direction:row; width:100%;">
                    <div id="sched-roche-cold-col" class="schedule-col" style="border-right:2px solid #eee; padding-right:10px;">
                        <h3 style="color:var(--roche-blue)">â„ï¸ å†·åº“ç»„æ’ç­</h3>
                        <div class="schedule-zone zone-base-container">
                            <div class="zone-title">ğŸ  æœ¬ç»„å‡ºå‹¤ <span id="count-roche-cold-base">0</span></div>
                            <div id="zone_roche_cold_base" class="zone-box sortable-zone" data-target="base_roche_cold"></div>
                        </div>
                        <div class="schedule-zone zone-sup-container">
                            <div class="zone-title">ğŸŸ§ æ”¯æ´äººå‘˜ <span id="count-roche-cold-sup">0</span></div>
                            <div id="zone_roche_cold_sup" class="zone-box sortable-zone" data-target="sup_roche_cold"></div>
                        </div>
                        <div class="schedule-zone zone-gap-container" style="background:#fff0f0; border-color:#fadbd8">
                            <div class="zone-title" style="color:#c0392b">ğŸŸ¥ äººå‘˜ç¼ºå£ (è‡ªåŠ¨ç”Ÿæˆ)</div>
                            <div id="gap_roche_cold_area" class="zone-box" style="border:none; background:transparent;"></div>
                        </div>
                    </div>
                    <div id="sched-roche-amb-col" class="schedule-col" style="padding-left:10px;">
                        <h3 style="color:var(--roche-sand)">â˜€ï¸ å¸¸æ¸©ç»„æ’ç­</h3>
                        <div class="schedule-zone zone-base-container">
                            <div class="zone-title">ğŸ  æœ¬ç»„å‡ºå‹¤ <span id="count-roche-amb-base">0</span></div>
                            <div id="zone_roche_amb_base" class="zone-box sortable-zone" data-target="base_roche_amb"></div>
                        </div>
                        <div class="schedule-zone zone-sup-container">
                            <div class="zone-title">ğŸŸ§ æ”¯æ´äººå‘˜ <span id="count-roche-amb-sup">0</span></div>
                            <div id="zone_roche_amb_sup" class="zone-box sortable-zone" data-target="sup_roche_amb"></div>
                        </div>
                        <div class="schedule-zone zone-gap-container" style="background:#fff0f0; border-color:#fadbd8">
                            <div class="zone-title" style="color:#c0392b">ğŸŸ¥ äººå‘˜ç¼ºå£ (è‡ªåŠ¨ç”Ÿæˆ)</div>
                            <div id="gap_roche_amb_area" class="zone-box" style="border:none; background:transparent;"></div>
                        </div>
                    </div>
                </div>

                <div id="sched-view-generic" class="schedule-col hidden">
                    <h3 id="sched-generic-title">âš™ï¸ é¡¹ç›®ç»„æ’ç­</h3>
                    <div class="schedule-zone zone-base-container">
                        <div class="zone-title">ğŸ  æœ¬ç»„å‡ºå‹¤ <span id="count-generic-base">0</span></div>
                        <div id="zone_generic_base" class="zone-box sortable-zone"></div>
                    </div>
                    <div class="schedule-zone zone-sup-container">
                        <div class="zone-title">ğŸŸ§ æ”¯æ´äººå‘˜ <span id="count-generic-sup">0</span></div>
                        <div id="zone_generic_sup" class="zone-box sortable-zone"></div>
                    </div>
                     <div class="schedule-zone zone-gap-container" style="background:#fff0f0; border-color:#fadbd8">
                        <div class="zone-title" style="color:#c0392b">ğŸŸ¥ äººå‘˜ç¼ºå£ (è‡ªåŠ¨ç”Ÿæˆ)</div>
                        <div id="gap_generic_area" class="zone-box" style="border:none; background:transparent;"></div>
                    </div>
                </div>
            </div>
            
            <button onclick="closeScheduler()" class="scheduler-close-btn" style="position:absolute; top:10px; right:10px; width:40px; height:40px; background:#e74c3c; color:white; border:none; border-radius:50%; font-size:20px; cursor:pointer;">Ã—</button>
        </div>
    </div>

<script>
    const date = new Date();
    const dateStr = date.getFullYear() + "å¹´" + (date.getMonth() + 1) + "æœˆ" + date.getDate() + "æ—¥";
    document.getElementById('currentDate').innerText = dateStr;

    let currentProject = 'roche_cold';
    
    // â˜… ä¿®å¤ç‚¹ 1ï¼šå››ä¸ªé¡¹ç›®æ‹¥æœ‰ç»å¯¹ç‹¬ç«‹çš„èµ„æºæ±  â˜…
    let staffData = {
        pool_roche_cold: [],
        pool_roche_amb: [],
        pool_device: [],
        pool_medicine: [],
        roche_cold_base: [], roche_cold_sup: [],
        roche_amb_base: [], roche_amb_sup: [],
        device_base: [], device_sup: [],
        medicine_base: [], medicine_sup: []
    };

    function calcStaff() {
        const groups = ['roche_cold', 'roche_amb', 'device', 'medicine'];
        groups.forEach(g => {
            const base = parseInt(document.getElementById('base_' + g)?.value) || 0;
            const sup = parseInt(document.getElementById('sup_' + g)?.value) || 0;
            const actual = Math.max(0, base + sup);
            const targetInput = document.getElementById('fc_' + g);
            if(targetInput) targetInput.value = actual;
        });
    }

    function switchView() {
        const select = document.getElementById('project-select');
        currentProject = select.value;
        const pageTitle = document.getElementById('page-title');
        
        document.getElementById('view-roche').classList.add('hidden');
        document.getElementById('view-device').classList.add('hidden');
        document.getElementById('view-medicine').classList.add('hidden');
        
        document.getElementById('formal-roche').classList.add('hidden');
        document.getElementById('formal-device').classList.add('hidden');
        document.getElementById('formal-medicine').classList.add('hidden');

        document.getElementById('dash-roche-group').classList.add('hidden');
        document.getElementById('dash-device-group').classList.add('hidden');
        document.getElementById('dash-medicine-group').classList.add('hidden');

        document.getElementById('shift_roche_cold_div').style.display = 'none';
        document.getElementById('shift_roche_amb_div').style.display = 'none';
        document.getElementById('shift_device_div').style.display = 'none';
        document.getElementById('shift_medicine_div').style.display = 'none';
        
        document.getElementById('btn-combined-pdf').style.display = 'none';

        document.getElementById('formal-roche-cold-group').classList.remove('hidden');
        document.getElementById('formal-roche-amb-group').classList.remove('hidden');
        document.getElementById('dash-roche-cold-card').classList.remove('hidden');
        document.getElementById('dash-roche-amb-card').classList.remove('hidden');
        document.getElementById('view-roche-cold-col').classList.remove('hidden');
        document.getElementById('view-roche-amb-col').classList.remove('hidden');

        const originSelect = document.getElementById('staff-origin');

        if (currentProject === 'roche_cold') {
            document.getElementById('shift_roche_cold_div').style.display = 'flex';
            originSelect.value = 'å†·åº“';
            pageTitle.innerText = "ç½—è¯Šå†·åº“é¡¹ç›®äººåŠ›æ’ç­å†³ç­–æ¨¡å‹";
            select.style.backgroundColor = "var(--roche-blue)";
            document.getElementById('view-roche').classList.remove('hidden');
            document.getElementById('formal-roche').classList.remove('hidden');
            document.getElementById('dash-roche-group').classList.remove('hidden');
            document.getElementById('dash-roche-group').style.display = 'flex'; 
            document.getElementById('formal-roche-amb-group').classList.add('hidden');
            document.getElementById('dash-roche-amb-card').classList.add('hidden');
            document.getElementById('view-roche-amb-col').classList.add('hidden');
            document.getElementById('btn-combined-pdf').style.display = 'block';
        } else if (currentProject === 'roche_amb') {
            document.getElementById('shift_roche_amb_div').style.display = 'flex';
            originSelect.value = 'å¸¸æ¸©';
            pageTitle.innerText = "ç½—è¯Šå¸¸æ¸©é¡¹ç›®äººåŠ›æ’ç­å†³ç­–æ¨¡å‹";
            select.style.backgroundColor = "var(--roche-sand)";
            document.getElementById('view-roche').classList.remove('hidden');
            document.getElementById('formal-roche').classList.remove('hidden');
            document.getElementById('dash-roche-group').classList.remove('hidden');
            document.getElementById('dash-roche-group').style.display = 'flex'; 
            document.getElementById('formal-roche-cold-group').classList.add('hidden');
            document.getElementById('dash-roche-cold-card').classList.add('hidden');
            document.getElementById('view-roche-cold-col').classList.add('hidden');
            document.getElementById('btn-combined-pdf').style.display = 'block';
        } else if (currentProject === 'device') {
            document.getElementById('shift_device_div').style.display = 'flex';
            originSelect.value = 'å™¨æ¢°';
            pageTitle.innerText = "å™¨æ¢°é¡¹ç›®äººåŠ›æ’ç­å†³ç­–æ¨¡å‹";
            select.style.backgroundColor = "var(--device-green)";
            document.getElementById('view-device').classList.remove('hidden');
            document.getElementById('formal-device').classList.remove('hidden');
            document.getElementById('dash-device-group').classList.remove('hidden');
            document.getElementById('dash-device-group').style.display = 'flex';
        } else if (currentProject === 'medicine') {
            document.getElementById('shift_medicine_div').style.display = 'flex';
            originSelect.value = 'è¯å“';
            pageTitle.innerText = "è¯å“é¡¹ç›®äººåŠ›æ’ç­å†³ç­–æ¨¡å‹";
            select.style.backgroundColor = "var(--medicine-purple)";
            document.getElementById('view-medicine').classList.remove('hidden');
            document.getElementById('formal-medicine').classList.remove('hidden');
            document.getElementById('dash-medicine-group').classList.remove('hidden');
            document.getElementById('dash-medicine-group').style.display = 'flex';
        }
        update();
    }

    function init() {
        const params = new URLSearchParams(window.location.search);
        loadStaffData();
        
        let alertMsg = "";

        if (params.has('sdata')) {
            try {
                const compressed = params.get('sdata');
                const jsonStr = decodeURIComponent(atob(compressed));
                const linkData = JSON.parse(jsonStr);
                
                const isPure = params.has('pure_source');
                const pureSource = params.get('pure_source');

                // â˜… ä¿®å¤ç‚¹ 2ï¼šä¸¥æ ¼ç‰©ç†éš”ç¦»çš„é˜²è¦†ç›–æ´—åœ°å¼•æ“ â˜…
                if (!isPure) {
                    document.querySelectorAll('.data-input').forEach(input => {
                        input.value = ""; 
                        localStorage.removeItem(input.id);
                    });
                } else {
                    if (pureSource === 'roche_cold') {
                        document.querySelectorAll('#view-roche-cold-col .data-input').forEach(i => { i.value=""; localStorage.removeItem(i.id); });
                    }
                    if (pureSource === 'roche_amb') {
                        document.querySelectorAll('#view-roche-amb-col .data-input').forEach(i => { i.value=""; localStorage.removeItem(i.id); });
                    }
                    if (pureSource === 'device') {
                        document.querySelectorAll('#view-device .data-input').forEach(i => { i.value=""; localStorage.removeItem(i.id); });
                    }
                    if (pureSource === 'medicine') {
                        document.querySelectorAll('#view-medicine .data-input').forEach(i => { i.value=""; localStorage.removeItem(i.id); });
                    }
                    
                    const sourceNames = {'roche_cold':'ç½—è¯Šå†·åº“', 'roche_amb':'ç½—è¯Šå¸¸æ¸©', 'device':'å™¨æ¢°', 'medicine':'è¯å“'};
                    alertMsg = `âœ… å·²æˆåŠŸåœ¨åå°åˆå¹¶ [${sourceNames[pureSource]}] çš„æ’ç­å’Œä¸šåŠ¡é‡ï¼\n\næ‚¨æœ¬åœ°æœ¬ç»„çš„ä¸šåŠ¡é‡å’Œå…¨å±€å‚æ•°æœªå—ä»»ä½•å½±å“ã€‚`;
                }

                if (!isPure) {
                    staffData = linkData;
                } else {
                    for (let key in linkData) {
                        if (Array.isArray(linkData[key])) {
                            staffData[key] = linkData[key];
                        }
                    }
                }

                // å…¨å±€æ’ç­å»é‡æŠ¤åŸæ²³
                let workingNames = new Set();
                for (let key in staffData) {
                    if (!key.startsWith('pool_')) {
                        staffData[key].forEach(staff => workingNames.add(staff.name));
                    }
                }

                const poolKeys = ['pool_roche_cold', 'pool_roche_amb', 'pool_device', 'pool_medicine'];
                let allPoolNames = new Set();
                
                poolKeys.forEach(pKey => {
                    let uniquePool = [];
                    if (staffData[pKey]) {
                        staffData[pKey].forEach(staff => {
                            if (!workingNames.has(staff.name) && !allPoolNames.has(staff.name)) {
                                uniquePool.push(staff);
                                allPoolNames.add(staff.name);
                            }
                        });
                        staffData[pKey] = uniquePool;
                    }
                });

                saveStaffData();
            } catch (e) {
                console.error("é“¾æ¥æ’ç­æ•°æ®è§£æå¤±è´¥", e);
            }
        }

        document.querySelectorAll('input, select').forEach(el => {
            if (el.id && params.has(el.id)) {
                el.value = params.get(el.id);
                localStorage.setItem(el.id, el.value);
            } else if (el.id) {
                const storedVal = localStorage.getItem(el.id);
                if (storedVal !== null) el.value = storedVal;
            }
        });
        
        if (params.has('project-select')) {
            document.getElementById('project-select').value = params.get('project-select');
        } else {
            const storedProj = localStorage.getItem('project-select');
            document.getElementById('project-select').value = storedProj || 'roche_cold';
        }
        
        switchView();

        if (alertMsg) {
            setTimeout(() => alert(alertMsg), 500);
        }
    }

    function update(e) {
        calcStaff();
        
        if (e && e.target && e.target.id) {
            localStorage.setItem(e.target.id, e.target.value);
        } else {
            document.querySelectorAll('input, select').forEach(el => {
                if(el.id) localStorage.setItem(el.id, el.value);
            });
        }

        const eff = parseFloat(document.getElementById('eff').value);
        const oee = parseFloat(document.getElementById('oee').value);
        
        let shiftCold = parseFloat(document.getElementById('shift_roche_cold').value) || 8;
        let shiftAmb = parseFloat(document.getElementById('shift_roche_amb').value) || 8;
        let shiftDevice = parseFloat(document.getElementById('shift_device').value) || 8;
        let shiftMedicine = parseFloat(document.getElementById('shift_medicine').value) || 8;

        document.getElementById('disp_eff').innerText = eff.toFixed(2);
        document.getElementById('disp_oee').innerText = oee.toFixed(2);
        
        if (currentProject === 'roche') {
             document.getElementById('res_shift').innerText = shiftCold === shiftAmb ? shiftCold : `â„ï¸${shiftCold} / â˜€ï¸${shiftAmb}`;
        } else if (currentProject === 'roche_cold') {
             document.getElementById('res_shift').innerText = shiftCold;
        } else if (currentProject === 'roche_amb') {
             document.getElementById('res_shift').innerText = shiftAmb;
        } else if (currentProject === 'device') {
             document.getElementById('res_shift').innerText = shiftDevice;
        } else {
             document.getElementById('res_shift').innerText = shiftMedicine;
        }

        let totalNeed = 0;
        let chartData = [];

        if (currentProject.startsWith('roche')) {
            const capCold = shiftCold * oee * eff;
            const capAmb = shiftAmb * oee * eff;   

            const fcCold = parseInt(document.getElementById('fc_roche_cold').value) || 0;
            const fcAmb = parseInt(document.getElementById('fc_roche_amb').value) || 0;
            let hoursCold = 0, hoursAmb = 0;

            document.querySelectorAll('#view-roche .data-input').forEach(input => {
                if (input.closest('.col').classList.contains('hidden')) return;

                const val = parseInt(input.value) || 0;
                if (val > 0) {
                    const uph = parseFloat(input.dataset.uph);
                    const hours = val / uph;
                    const isAmb = input.dataset.subtype === 'amb';
                    const label = input.previousElementSibling.innerText;
                    const groupTitle = input.closest('.card').querySelector('h4').innerText.split(' ')[1] || "";
                    const fullName = groupTitle ? `${groupTitle}-${label}` : label;

                    if (isAmb) {
                        hoursAmb += hours;
                    } else {
                        hoursCold += hours;
                    }
                    
                    chartData.push({ 
                        name: fullName, 
                        hours: hours, 
                        people: hours / (isAmb ? capAmb : capCold), 
                        color: isAmb ? 'var(--roche-sand)' : 'var(--roche-blue)' 
                    });
                }
            });
            
            const gapCold = Math.max(0, (hoursCold / oee) - (fcCold * shiftCold));
            const gapAmb = Math.max(0, (hoursAmb / oee) - (fcAmb * shiftAmb));
            
            const needCold = Math.ceil(gapCold / capCold);
            const needAmb = Math.ceil(gapAmb / capAmb);

            document.getElementById('res_roche_cold').innerText = needCold + " äºº";
            document.getElementById('gap_roche_cold').innerText = gapCold.toFixed(1);
            document.getElementById('res_roche_amb').innerText = needAmb + " äºº";
            document.getElementById('gap_roche_amb').innerText = gapAmb.toFixed(1);
            
            if (currentProject === 'roche') {
                totalNeed = needCold + needAmb; 
            } else if (currentProject === 'roche_cold') {
                totalNeed = needCold;
            } else {
                totalNeed = needAmb;
            }
            
        } else if (currentProject === 'device') {
            const capGen = shiftDevice * oee * eff;
            const fc = parseInt(document.getElementById('fc_device').value) || 0;
            let totalHours = 0;
            
            document.querySelectorAll('#view-device .data-input').forEach(input => {
                const val = parseInt(input.value) || 0;
                if (val > 0) {
                    const uph = parseFloat(input.dataset.uph);
                    const hours = val / uph;
                    const label = input.previousElementSibling.innerText;
                    const groupTitle = input.closest('.card').querySelector('h4').innerText.split(' ')[1] || "";
                    const fullName = `${groupTitle}-${label}`;
                    
                    totalHours += hours;
                    chartData.push({ name: fullName, hours: hours, people: hours / capGen, color: 'var(--device-green)' });
                }
            });
            
            const gap = Math.max(0, (totalHours / oee) - (fc * shiftDevice)); 
            const need = Math.ceil(gap / capGen);
            document.getElementById('res_device').innerText = need + " äºº";
            document.getElementById('gap_device').innerText = gap.toFixed(1);
            totalNeed = need;
            
        } else if (currentProject === 'medicine') {
            const capGen = shiftMedicine * oee * eff;
            const fc = parseInt(document.getElementById('fc_medicine').value) || 0;
            let totalHours = 0;
            
            document.querySelectorAll('#view-medicine .data-input').forEach(input => {
                const val = parseInt(input.value) || 0;
                if (val > 0) {
                    const uph = parseFloat(input.dataset.uph);
                    const hours = val / uph;
                    const label = input.previousElementSibling.innerText;
                    const groupTitle = input.closest('.card').querySelector('h4').innerText.split(' ')[1] || "";
                    const fullName = `${groupTitle}-${label}`;
                    
                    totalHours += hours;
                    chartData.push({ name: fullName, hours: hours, people: hours / capGen, color: 'var(--medicine-purple)' });
                }
            });
            
            const gap = Math.max(0, (totalHours / oee) - (fc * shiftMedicine)); 
            const need = Math.ceil(gap / capGen);
            document.getElementById('res_medicine').innerText = need + " äºº";
            document.getElementById('gap_medicine').innerText = gap.toFixed(1);
            totalNeed = need;
        }

        document.getElementById('res_total').innerText = totalNeed + " äºº";
        renderChart(chartData);
        syncGapBlocks();
    }

    function renderChart(data) {
        const container = document.getElementById('chart-area');
        container.innerHTML = "";
        
        if (data.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">æš‚æ— è¾“å…¥æ•°æ®</div>';
            return;
        }
        
        data.sort((a, b) => b.hours - a.hours);
        const maxHours = data[0].hours;
        
        data.forEach(item => {
            const widthPct = (item.hours / maxHours) * 100;
            const peopleNum = item.people < 0.1 ? "<0.1" : item.people.toFixed(1);
            const row = document.createElement('div');
            row.className = 'chart-row';
            row.innerHTML = `<div class="chart-label" title="${item.name}">${item.name}</div>
                <div class="chart-bar-area"><div class="chart-bar" style="width: ${widthPct}%; background-color: ${item.color}">${item.hours.toFixed(1)} å°æ—¶</div></div>
                <div class="chart-val">æ¨è: ${peopleNum}äºº</div>`;
            container.appendChild(row);
        });
    }

    function clearData(isFull = false) {
        if (confirm(isFull ? "æ¸…ç©ºæ‰€æœ‰ç»„çš„ä¸šåŠ¡é‡ï¼Ÿ" : "æ¸…ç©ºå½“å‰ç»„çš„ä¸šåŠ¡é‡ï¼Ÿ")) {
            if (isFull) {
                document.querySelectorAll('.data-input').forEach(i => { 
                    i.value = ""; 
                    localStorage.removeItem(i.id); 
                });
            } else {
                const baseId = currentProject.startsWith('roche') ? 'view-roche' : `view-${currentProject}`;
                document.querySelectorAll(`#${baseId} .data-input`).forEach(i => {
                    if (!i.closest('.col').classList.contains('hidden')) { 
                        i.value = ""; 
                        localStorage.removeItem(i.id); 
                    }
                });
            }
            update();
        }
    }

    function returnAllToPool() {
        if (confirm("ç¡®å®šè¦å°†ã€å½“å‰ç»„ã€‘åœ¨å²—äººå‘˜å…¨éƒ¨é€€å›ä¸“å±èµ„æºæ± å—ï¼Ÿ")) {
            let currentPoolKey = 'pool_' + currentProject;
            if (currentProject === 'roche') return; // é˜²æ­¢åŒæ¨¡å¼ä¸‹è¯¯æ“ä½œ
            
            let zonesToClear = [];
            if (currentProject === 'roche_cold') zonesToClear = ['roche_cold_base', 'roche_cold_sup'];
            else if (currentProject === 'roche_amb') zonesToClear = ['roche_amb_base', 'roche_amb_sup'];
            else if (currentProject === 'device') zonesToClear = ['device_base', 'device_sup'];
            else if (currentProject === 'medicine') zonesToClear = ['medicine_base', 'medicine_sup'];

            if (!staffData[currentPoolKey]) staffData[currentPoolKey] = [];

            zonesToClear.forEach(zone => {
                if (staffData[zone] && staffData[zone].length > 0) {
                    staffData[currentPoolKey].push(...staffData[zone]);
                    staffData[zone] = []; 
                }
            });
            
            saveStaffData();
            renderScheduler();
        }
    }

    function clearResourcePool() {
        if (confirm("ç¡®å®šè¦ã€å½»åº•æ¸…ç©ºã€‘å½“å‰ä¸“å±èµ„æºæ± å—ï¼Ÿ")) { 
            let currentPoolKey = 'pool_' + currentProject;
            staffData[currentPoolKey] = []; 
            saveStaffData(); 
            renderScheduler(); 
        }
    }

    function openScheduler() { 
        document.getElementById('scheduler-modal').style.display = 'flex'; 
        loadStaffData(); 
        renderScheduler(); 
    }
    
    function closeScheduler() { 
        document.getElementById('scheduler-modal').style.display = 'none'; 
        saveStaffData(); 
    }

    function loadStaffData() {
        // â˜… å¯ç”¨ v8 æ–°å­˜æ¡£ï¼Œé¿å…ä¸è€æ•°æ®æ ¼å¼å†²çª â˜…
        const stored = localStorage.getItem('staffData_v8');
        if (stored) { 
            try { 
                staffData = JSON.parse(stored); 
            } catch(e) {} 
        }
        initSortable();
    }

    function saveStaffData() {
        localStorage.setItem('staffData_v8', JSON.stringify(staffData));
        updateMainInputsFromScheduler();
    }

    function updateMainInputsFromScheduler() {
        const map = {
            'roche_cold_base': 'base_roche_cold', 'roche_cold_sup': 'sup_roche_cold',
            'roche_amb_base': 'base_roche_amb', 'roche_amb_sup': 'sup_roche_amb',
            'device_base': 'base_device', 'device_sup': 'sup_device',
            'medicine_base': 'base_medicine', 'medicine_sup': 'sup_medicine'
        };
        for (let key in map) {
            const count = staffData[key] ? staffData[key].length : 0;
            const input = document.getElementById(map[key]);
            if (input) { 
                input.value = count; 
                const span = document.getElementById('count-' + key.replace(/_/g, '-'));
                if (span) span.innerText = count;
            }
        }
        update();
    }

    function renderScheduler() {
        const poolEl = document.getElementById('pool-container');
        poolEl.innerHTML = '';
        
        // â˜… ä»…æ¸²æŸ“å±äºå½“å‰ç»„çš„ä¸“å±æ± å­ â˜…
        let currentPoolKey = 'pool_' + currentProject;
        if (currentProject === 'roche') currentPoolKey = 'pool_roche_cold';
        
        if (staffData[currentPoolKey]) {
            staffData[currentPoolKey].forEach((s, i) => {
                poolEl.appendChild(createStaffEl(s, currentPoolKey, i));
            });
        }

        document.getElementById('sched-view-roche').classList.add('hidden');
        document.getElementById('sched-view-generic').classList.add('hidden');
        document.getElementById('sched-roche-cold-col').style.display = 'flex';
        document.getElementById('sched-roche-amb-col').style.display = 'flex';

        if (currentProject.startsWith('roche')) {
            document.getElementById('sched-view-roche').classList.remove('hidden');
            if (currentProject === 'roche_cold') document.getElementById('sched-roche-amb-col').style.display = 'none';
            else if (currentProject === 'roche_amb') document.getElementById('sched-roche-cold-col').style.display = 'none';
        } else {
            document.getElementById('sched-view-generic').classList.remove('hidden');
            document.getElementById('sched-generic-title').innerText = currentProject === 'device' ? 'âš™ï¸ å™¨æ¢°ç»„æ’ç­' : 'ğŸŒ¿ è¯å“ç»„æ’ç­';
            document.getElementById('zone_generic_base').id = `zone_${currentProject}_base`;
            document.getElementById('zone_generic_sup').id = `zone_${currentProject}_sup`;
        }

        const zones = ['roche_cold_base', 'roche_cold_sup', 'roche_amb_base', 'roche_amb_sup', 'device_base', 'device_sup', 'medicine_base', 'medicine_sup'];
        zones.forEach(z => {
            const el = document.getElementById('zone_' + z);
            if (el) {
                el.innerHTML = '';
                if (staffData[z]) {
                    staffData[z].forEach((s, i) => el.appendChild(createStaffEl(s, z, i)));
                }
            }
        });
        updateMainInputsFromScheduler();
    }

    function createStaffEl(s, key, idx) {
        const div = document.createElement('div');
        div.className = `staff-card staff-type-${s.type}`;
        
        let origin = '';
        if (currentProject.startsWith('roche')) {
            origin = (key.includes('cold') || currentProject === 'roche_cold') ? 'å†·åº“' : 'å¸¸æ¸©';
        } else {
            origin = currentProject === 'device' ? 'å™¨æ¢°' : 'è¯å“';
        }
        
        let name = s.name;
        if (s.origin && s.origin !== origin) {
            name = `(${s.origin})${s.name}`;
        }
        
        div.innerHTML = `${name} <span class="staff-delete" onclick="removeStaff('${key}', ${idx})">Ã—</span>`;
        return div;
    }

    function addNewStaff() {
        const input = document.getElementById('new-staff-names');
        const names = input.value.trim().split(/[\s,ï¼Œ]+/);
        const type = document.querySelector('input[name="staffType"]:checked').value;
        const origin = document.getElementById('staff-origin').value;
        
        let currentPoolKey = 'pool_' + currentProject;
        if (currentProject === 'roche') currentPoolKey = 'pool_roche_cold';
        
        if (!staffData[currentPoolKey]) staffData[currentPoolKey] = [];

        names.forEach(n => {
            if (n) {
                let exist = false;
                for (let k in staffData) { 
                    if (staffData[k] && staffData[k].some(s => s.name === n)) {
                        exist = true; 
                    }
                }
                if (!exist) {
                    staffData[currentPoolKey].push({ id: Date.now() + Math.random(), name: n, type: type, origin: origin });
                }
            }
        });
        
        input.value = ''; 
        saveStaffData(); 
        renderScheduler();
    }

    function removeStaff(key, i) {
        const s = staffData[key].splice(i, 1)[0];
        
        let currentPoolKey = 'pool_' + currentProject;
        if (currentProject === 'roche') currentPoolKey = 'pool_roche_cold';
        
        if (!key.startsWith('pool_')) {
            if (!staffData[currentPoolKey]) staffData[currentPoolKey] = [];
            staffData[currentPoolKey].push(s);
        }
        
        saveStaffData(); 
        renderScheduler();
    }

    function syncGapBlocks() {
        const map = { 'gap_roche_cold_area': 'res_roche_cold', 'gap_roche_amb_area': 'res_roche_amb', 'gap_generic_area': currentProject === 'device' ? 'res_device' : 'res_medicine' };
        for (let a in map) {
            const el = document.getElementById(a);
            if (!el) continue;
            
            el.innerHTML = '';
            if (!currentProject.startsWith('roche') && a.includes('roche')) continue;
            if (currentProject.startsWith('roche') && a === 'gap_generic_area') continue;
            
            const need = parseInt(document.getElementById(map[a]).innerText) || 0;
            if (need > 0) { 
                for (let i=0; i<need; i++) {
                    el.innerHTML += '<div class="gap-block">ç¼ºå£'+(i+1)+'</div>'; 
                }
            } else {
                el.innerHTML = '<div style="font-size:12px; color:#27ae60; padding:5px;">âœ¨ äººå‘˜å……è¶³</div>';
            }
        }
    }

    function initSortable() {
        document.querySelectorAll('.pool-container, .sortable-zone').forEach(el => {
            if (el._sortable) el._sortable.destroy();
            el._sortable = new Sortable(el, {
                group: 'staff', 
                animation: 150, 
                onEnd: function(evt) {
                    let currentPoolKey = 'pool_' + currentProject;
                    if (currentProject === 'roche') currentPoolKey = 'pool_roche_cold';
                    
                    const f = evt.from.id === 'pool-container' ? currentPoolKey : evt.from.id.replace('zone_', '');
                    const t = evt.to.id === 'pool-container' ? currentPoolKey : evt.to.id.replace('zone_', '');
                    
                    if (f === t && evt.newIndex === evt.oldIndex) return;
                    
                    const item = staffData[f].splice(evt.oldIndex, 1)[0];
                    if (!staffData[t]) staffData[t] = [];
                    staffData[t].splice(evt.newIndex, 0, item);
                    saveStaffData();
                }
            });
        });
    }

    async function generateCombinedPDF() {
        document.getElementById('formal-roche-cold-group').classList.remove('hidden');
        document.getElementById('dash-roche-cold-card').classList.remove('hidden');
        document.getElementById('view-roche-cold-col').classList.remove('hidden');
        document.getElementById('sched-roche-cold-col').style.display = 'flex';
        
        document.getElementById('formal-roche-amb-group').classList.remove('hidden');
        document.getElementById('dash-roche-amb-card').classList.remove('hidden');
        document.getElementById('view-roche-amb-col').classList.remove('hidden');
        document.getElementById('sched-roche-amb-col').style.display = 'flex';
        
        const old = currentProject; 
        currentProject = 'roche';
        document.getElementById('page-title').innerText = "ç½—è¯Šé¡¹ç›®è”åˆæ—¥æŠ¥";
        update(); 
        await generatePDF(true);
        currentProject = old; 
        switchView();
    }

    async function generatePDF(isCombined = false) {
        const { jsPDF } = window.jspdf;
        const msg = document.getElementById('pdf-msg');
        msg.style.display = 'block';
        
        let target = isCombined ? 'roche' : currentProject;
        const colC = document.getElementById('sched-roche-cold-col');
        const colA = document.getElementById('sched-roche-amb-col');
        
        // â˜… ä¿®å¤ 2ï¼šæˆªå›¾å‰å¼ºåˆ¶é¢„ç”»ä¸€æ¬¡æ²™ç›˜å¡ç‰‡ï¼Œå½»åº•è§£å†³æˆªå›¾ç©ºç™½é—®é¢˜
        renderScheduler();
        
        if (!isCombined) {
            if (target === 'roche_cold') { 
                colC.style.display = 'flex'; 
                colA.style.display = 'none'; 
            } else if (target === 'roche_amb') { 
                colC.style.display = 'none'; 
                colA.style.display = 'flex'; 
            }
        }

        const modal = document.getElementById('scheduler-modal');
        const content = document.getElementById('scheduler-capture-area');
        const oldStyle = content.style.cssText;
        modal.style.display = 'flex';
        content.classList.add('pdf-mode-active');
        content.style.width = '1300px'; 
        content.style.height = 'auto'; 
        content.style.position = 'fixed'; 
        content.style.top = '-9999px';
        document.body.appendChild(content);

        try {
            await new Promise(r => setTimeout(r, 400));
            const canvasS = await html2canvas(content, { 
                scale: 1.5, 
                useCORS: true, 
                backgroundColor: '#ffffff', 
                windowWidth: 1600 
            });
            const imgS = canvasS.toDataURL('image/png');
            
            const pCon = document.getElementById('pdf-container');
            let html = `<div class="pdf-header"><div class="pdf-title">${document.getElementById('page-title').innerText}</div><div class="pdf-date">${dateStr}</div></div>`;
            pCon.innerHTML = html + "ï¼ˆæŠ¥è¡¨ç”Ÿæˆä¸­...ï¼‰"; 
            
            const pdf = new jsPDF('p', 'mm', 'a4');
            pdf.text(isCombined ? "ç½—è¯Šè”åˆç‰ˆæ—¥æŠ¥" : "äººåŠ›å†³ç­–æ—¥æŠ¥", 10, 10);
            pdf.addPage();
            pdf.addImage(imgS, 'PNG', 10, 10, 190, (canvasS.height * 190) / canvasS.width);
            pdf.save(`${isCombined ? 'ç½—è¯Šè”åˆ' : 'å•ç»„'}_æ—¥æŠ¥_${dateStr}.pdf`);
        } catch(e) { 
            console.error(e); 
        } finally {
            content.classList.remove('pdf-mode-active');
            document.getElementById('scheduler-modal').appendChild(content);
            content.style.cssText = oldStyle;
            modal.style.display = 'none';
            msg.style.display = 'none';
        }
    }

    function generateLink(isFull = false) {
        const p = new URLSearchParams();
        
        document.querySelectorAll('input, select').forEach(el => {
            if (el.id && el.value != 0) {
                if (!isFull) {
                    // â˜… ä¿®å¤ 3ï¼šçº¯å‡€æ¨¡å¼ä¸‹ç²¾å‡†éš”ç¦»ï¼Œç¡®ä¿ä¸å¸¦èµ°å…¨å±€å‚æ•°ï¼ˆeff/oeeï¼‰
                    if (el.id === 'project-select') {
                        // å…è®¸å¸¦é¡¹ç›®åç§°
                    } else if (currentProject === 'roche_cold') { 
                        if (!el.closest('#view-roche-cold-col') && el.id !== 'shift_roche_cold') return; 
                    } else if (currentProject === 'roche_amb') { 
                        if (!el.closest('#view-roche-amb-col') && el.id !== 'shift_roche_amb') return; 
                    } else if (currentProject === 'device') { 
                        if (!el.closest('#view-device') && el.id !== 'shift_device') return; 
                    } else if (currentProject === 'medicine') { 
                        if (!el.closest('#view-medicine') && el.id !== 'shift_medicine') return; 
                    } else {
                        // æ‹¦æˆªå…¨å±€ç³»æ•°
                        return;
                    }
                }
                p.set(el.id, el.value);
            }
        });
        
        if (!isFull) {
            p.set('pure_source', currentProject);
        }
        
        try {
            let data = {};
            if (isFull) {
                data = staffData;
            } else {
                let keys = [];
                if (currentProject === 'roche_cold') keys = ['roche_cold_base', 'roche_cold_sup', 'pool_roche_cold'];
                else if (currentProject === 'roche_amb') keys = ['roche_amb_base', 'roche_amb_sup', 'pool_roche_amb'];
                else if (currentProject === 'device') keys = ['device_base', 'device_sup', 'pool_device'];
                else if (currentProject === 'medicine') keys = ['medicine_base', 'medicine_sup', 'pool_medicine'];
                
                keys.forEach(k => {
                    if (staffData[k]) data[k] = staffData[k];
                });
            }
            p.set('sdata', btoa(encodeURIComponent(JSON.stringify(data))));
        } catch(e) {}
        
        const url = window.location.origin + window.location.pathname + '?' + p.toString();
        
        navigator.clipboard.writeText(url).then(() => {
            document.getElementById('link-msg').style.display = 'block';
            setTimeout(() => document.getElementById('link-msg').style.display = 'none', 3000);
        });
    }

    document.querySelectorAll('input, select').forEach(el => el.addEventListener('input', update));
    window.onload = init;
</script>

</body>
</html>